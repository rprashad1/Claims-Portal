@using ClaimsPortal.Models
@using ClaimsPortal.Services
@implements IAsyncDisposable

<div class="address-template-container">
    <!-- Address Line 1 -->
    <div class="mb-3">
        <label class="form-label">@Label1</label>
        <div class="input-group">
            <input type="text" 
                   class="form-control" 
                   @bind="StreetAddress" 
                   @oninput="OnAddressInput"
                   placeholder="Enter street address"
                   autocomplete="off" />
            @if (!string.IsNullOrEmpty(StreetAddress))
            {
                <button class="btn btn-outline-secondary" type="button" @onclick="ClearAddress1">
                    <i class="bi bi-x"></i>
                </button>
            }
        </div>
        
        <!-- Address Search Suggestions -->
        @if (ShowSuggestions && Suggestions.Count > 0)
        {
            <div class="list-group mt-1" style="max-height: 300px; overflow-y: auto;">
                @foreach (var suggestion in Suggestions)
                {
                    <button type="button" 
                            class="list-group-item list-group-item-action text-start" 
                            @onclick="@(() => SelectSuggestion(suggestion))">
                        <div>@suggestion.Address</div>
                        <small class="text-muted">@suggestion.City, @suggestion.State @suggestion.ZipCode</small>
                    </button>
                }
            </div>
        }
    </div>

    <!-- Address Line 2 (Optional) -->
    <div class="mb-3">
        <label class="form-label">@Label2 (Optional)</label>
        <input type="text" 
               class="form-control" 
               @bind="AddressLine2" 
               placeholder="Apt, Suite, etc." />
    </div>

    <!-- City, State, Zip Row -->
    <div class="row g-3 mb-3">
        <div class="col-md-6">
            <label class="form-label">City</label>
            <input type="text" 
                   class="form-control" 
                   @bind="City" 
                   placeholder="City" />
        </div>
        <div class="col-md-2">
            <label class="form-label">State</label>
            <input type="text" 
                   class="form-control" 
                   @bind="State" 
                   maxlength="2" 
                   placeholder="State" />
        </div>
        <div class="col-md-4">
            <label class="form-label">Zip Code</label>
            <input type="text" 
                   class="form-control" 
                   @bind="ZipCode" 
                   maxlength="10" 
                   placeholder="Zip Code" />
        </div>
    </div>
</div>

@code {
    [Parameter]
    public string? StreetAddress { get; set; }

    [Parameter]
    public EventCallback<string?> StreetAddressChanged { get; set; }

    [Parameter]
    public string? AddressLine2 { get; set; }

    [Parameter]
    public EventCallback<string?> AddressLine2Changed { get; set; }

    [Parameter]
    public string? City { get; set; }

    [Parameter]
    public EventCallback<string?> CityChanged { get; set; }

    [Parameter]
    public string? State { get; set; }

    [Parameter]
    public EventCallback<string?> StateChanged { get; set; }

    [Parameter]
    public string? ZipCode { get; set; }

    [Parameter]
    public EventCallback<string?> ZipCodeChanged { get; set; }

    [Parameter]
    public string Label1 { get; set; } = "Street Address";

    [Parameter]
    public string Label2 { get; set; } = "Address Line 2";

    [Inject]
    private IAddressService AddressService { get; set; } = null!;

    private List<AddressSearchResult> Suggestions = [];
    private bool ShowSuggestions = false;
    private CancellationTokenSource? _searchCancellation;
    private System.Threading.Timer? _debounceTimer;

    private async Task OnAddressInput(ChangeEventArgs e)
    {
        var input = e.Value?.ToString() ?? string.Empty;
        await StreetAddressChanged.InvokeAsync(input);

        _searchCancellation?.Cancel();
        _searchCancellation = new CancellationTokenSource();

        _debounceTimer?.Dispose();
        
        if (input.Length < 3)
        {
            ShowSuggestions = false;
            Suggestions = [];
            return;
        }

        _debounceTimer = new System.Threading.Timer(async _ =>
        {
            try
            {
                Suggestions = await AddressService.SearchAddressesAsync(input);
                ShowSuggestions = Suggestions.Count > 0;
                await InvokeAsync(StateHasChanged);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error searching addresses: {ex.Message}");
            }
        }, null, 300, System.Threading.Timeout.Infinite);
    }

    private async Task SelectSuggestion(AddressSearchResult result)
    {
        await StreetAddressChanged.InvokeAsync(result.Address);
        await CityChanged.InvokeAsync(result.City);
        await StateChanged.InvokeAsync(result.State);
        await ZipCodeChanged.InvokeAsync(result.ZipCode);

        StreetAddress = result.Address;
        City = result.City;
        State = result.State;
        ZipCode = result.ZipCode;

        ShowSuggestions = false;
        Suggestions = [];
    }

    private async Task ClearAddress1()
    {
        await StreetAddressChanged.InvokeAsync(null);
        StreetAddress = null;
        ShowSuggestions = false;
        Suggestions = [];
    }

    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        _debounceTimer?.Dispose();
        _searchCancellation?.Dispose();
    }
}

<style>
    .address-template-container {
        /* Component scoped styles */
    }

    .address-template-container .list-group-item {
        cursor: pointer;
        transition: background-color 0.15s ease-in-out;
    }

    .address-template-container .list-group-item:hover {
        background-color: #f0f0f0;
    }
</style>
