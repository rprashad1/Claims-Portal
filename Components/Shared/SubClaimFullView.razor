@using ClaimsPortal.Models
@using ClaimsPortal.Services
@using ClaimsPortal.Components.Modals
@rendermode InteractiveServer

@* 
    SubClaimFullView - A shared component for full sub-claim management
    Can be used inline (embedded in other pages) or in the standalone SubClaimView page.
    When used inline, the navigation buttons are hidden and the content expands in place.
*@

<div class="subclaim-fullview">
    @if (IsLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-muted">Loading sub-claims...</p>
        </div>
    }
    else if (CurrentClaim != null)
    {
        <!-- Claim Summary Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="alert alert-info mb-0">
                    <div class="row">
                        <div class="col-md-3">
                            <small class="text-muted d-block">Claim Number</small>
                            <strong class="text-primary">@CurrentClaim.ClaimNumber</strong>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted d-block">Policy Number</small>
                            <strong>@(CurrentClaim.PolicyInfo?.PolicyNumber ?? "")</strong>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted d-block">Insured</small>
                            <strong>@(CurrentClaim.PolicyInfo?.InsuredName ?? "")</strong>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted d-block">Claim Status</small>
                            <span class="badge @GetClaimStatusBadgeClass(CurrentClaim.Status) fs-6">@CurrentClaim.Status</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Icons Bar (appears when rows selected) -->
        @if (SelectedSubClaims.Any())
        {
            <div class="action-toolbar mb-4">
                <div class="card border-primary">
                    <div class="card-body py-3">
                        <div class="d-flex justify-content-start align-items-center gap-4 flex-wrap">
                            <span class="text-muted me-2">
                                <strong>@SelectedSubClaims.Count</strong> feature(s) selected
                            </span>
                            
                            <div class="vr"></div>
                            
                            @{
                                var selectedItems = SubClaimsList.Where(s => SelectedSubClaims.Contains(s.Id)).ToList();
                                var allClosed = selectedItems.All(s => s.Status == "Closed");
                                var allOpenOrReopened = selectedItems.All(s => s.Status == "Open" || s.Status == "Reopened");
                            }
                            
                            @if (allClosed)
                            {
                                <div class="action-icon-group text-center">
                                    <button class="btn btn-link p-0" @onclick="ShowReopenModal" title="Reopen Feature" disabled="@IsProcessing">
                                        <i class="bi bi-arrow-counterclockwise" style="font-size: 1.5rem; color: #28a745;"></i>
                                    </button>
                                    <div class="action-label text-success">Reopen<br/>Feature</div>
                                </div>
                            }
                            else if (allOpenOrReopened)
                            {
                                <div class="action-icon-group text-center">
                                    <button class="btn btn-link p-0" @onclick="ShowCloseModal" title="Close Feature" disabled="@IsProcessing">
                                        <i class="bi bi-x-circle" style="font-size: 1.5rem; color: #dc3545;"></i>
                                    </button>
                                    <div class="action-label text-danger">Close<br/>Feature</div>
                                </div>
                            }
                            else
                            {
                                <!-- Mixed status - show both but disabled with tooltip -->
                                <div class="action-icon-group text-center">
                                    <button class="btn btn-link p-0" title="Select features with same status" disabled>
                                        <i class="bi bi-exclamation-circle" style="font-size: 1.5rem; color: #6c757d;"></i>
                                    </button>
                                    <div class="action-label text-muted">Mixed<br/>Status</div>
                                </div>
                            }

                            <div class="action-icon-group text-center">
                                <button class="btn btn-link p-0" @onclick="@(() => PerformAction("LossReserve"))" title="Loss Reserve">
                                    <i class="bi bi-piggy-bank-fill" style="font-size: 1.5rem; color: #fd7e14;"></i>
                                </button>
                                <div class="action-label">Loss<br/>Reserve</div>
                            </div>

                            <div class="action-icon-group text-center">
                                <button class="btn btn-link p-0" @onclick="@(() => PerformAction("ExpenseReserve"))" title="Expense Reserve">
                                    <i class="bi bi-wallet-fill" style="font-size: 1.5rem; color: #fd7e14;"></i>
                                </button>
                                <div class="action-label">Expense<br/>Reserve</div>
                            </div>

                            <div class="action-icon-group text-center">
                                <button class="btn btn-link p-0" @onclick="@(() => PerformAction("LossPayment"))" title="Loss Payment">
                                    <i class="bi bi-cash-stack" style="font-size: 1.5rem; color: #198754;"></i>
                                </button>
                                <div class="action-label">Loss<br/>Payment</div>
                            </div>

                            <div class="action-icon-group text-center">
                                <button class="btn btn-link p-0" @onclick="@(() => PerformAction("ExpensePayment"))" title="Expense Payment">
                                    <i class="bi bi-cash-coin" style="font-size: 1.5rem; color: #198754;"></i>
                                </button>
                                <div class="action-label">Expense<br/>Payment</div>
                            </div>

                            <div class="action-icon-group text-center">
                                <button class="btn btn-link p-0" @onclick="@(() => PerformAction("Salvage"))" title="Salvage">
                                    <i class="bi bi-recycle" style="font-size: 1.5rem; color: #0dcaf0;"></i>
                                </button>
                                <div class="action-label">Salvage</div>
                            </div>

                            <div class="action-icon-group text-center">
                                <button class="btn btn-link p-0" @onclick="@(() => PerformAction("Subrogation"))" title="Subrogation">
                                    <i class="bi bi-arrow-left-right" style="font-size: 1.5rem; color: #0dcaf0;"></i>
                                </button>
                                <div class="action-label">Subrogation</div>
                            </div>

                            <div class="action-icon-group text-center">
                                <button class="btn btn-link p-0" @onclick="@(() => PerformAction("Litigation"))" title="Litigation">
                                    <i class="bi bi-balance-fill" style="font-size: 1.5rem; color: #6f42c1;"></i>
                                </button>
                                <div class="action-label">Litigation</div>
                            </div>

                            <div class="action-icon-group text-center">
                                <button class="btn btn-link p-0" @onclick="@(() => PerformAction("Arbitration"))" title="Arbitration">
                                    <i class="bi bi-briefcase-fill" style="font-size: 1.5rem; color: #6f42c1;"></i>
                                </button>
                                <div class="action-label">Arbitration</div>
                            </div>
                            
                            <div class="action-icon-group text-center">
                                <button class="btn btn-link p-0" @onclick="@(() => PerformAction("Negotiation"))" title="Negotiation">
                                    <i class="bi bi-people-fill" style="font-size: 1.5rem; color: #6f42c1;"></i>
                                </button>
                                <div class="action-label">Negotiation</div>
                            </div>
                        </div>
                        
                        @if (IsProcessing)
                        {
                            <div class="text-center mt-2">
                                <span class="spinner-border spinner-border-sm text-primary" role="status"></span>
                                <span class="ms-2 text-muted">Processing...</span>
                            </div>
                        }
                        
                        @if (!string.IsNullOrEmpty(StatusMessage))
                        {
                            <div class="alert @(StatusMessage.Contains("Error") ? "alert-danger" : "alert-success") mt-2 mb-0 py-2">
                                <small>@StatusMessage</small>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }

        <!-- Sub-Claims Grid -->
        <div class="card">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-table me-2"></i>Features / Sub-Claims</h5>
                <span class="badge bg-primary">@SubClaimsList.Count Total</span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0 subclaim-grid">
                        <thead class="table-dark">
                            <tr>
                                <th class="text-center" style="width: 40px;">
                                    <input type="checkbox" class="form-check-input" @onchange="SelectAll" 
                                           checked="@(SelectedSubClaims.Count == SubClaimsList.Count && SubClaimsList.Any())" />
                                </th>
                                <th style="width: 80px;">Feature</th>
                                <th>Coverage/Limits</th>
                                <th>Claimant</th>
                                <th>Adjuster</th>
                                <th class="text-end">Exp. Reserve</th>
                                <th class="text-end">Exp. Paid</th>
                                <th class="text-end">Ind. Reserve</th>
                                <th class="text-end">Ind. Paid</th>
                                <th class="text-end">Recovery</th>
                                <th class="text-end">Offset</th>
                                <th class="text-center" style="width: 80px;">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (SubClaimsList.Any())
                            {
                                @foreach (var subClaim in SubClaimsList)
                                {
                                    <tr class="@(SelectedSubClaims.Contains(subClaim.Id) ? "table-primary selected-row" : "")">
                                        <td class="text-center">
                                            <input type="checkbox" 
                                                   class="form-check-input" 
                                                   @onchange="@((ChangeEventArgs e) => ToggleSelection(subClaim.Id, (bool)e.Value!))" 
                                                   checked="@SelectedSubClaims.Contains(subClaim.Id)" />
                                        </td>
                                        <td>
                                            <span class="badge bg-primary">@subClaim.FeatureNumber.ToString("D2")</span>
                                        </td>
                                        <td>
                                            <strong>@subClaim.Coverage</strong>
                                            @if (!string.IsNullOrEmpty(subClaim.CoverageLimits))
                                            {
                                                <span class="text-muted">- @subClaim.CoverageLimits</span>
                                            }
                                        </td>
                                        <td>@subClaim.ClaimantName</td>
                                        <td>@(string.IsNullOrEmpty(subClaim.AssignedAdjusterName) ? "-" : subClaim.AssignedAdjusterName)</td>
                                        <td class="text-end font-monospace">@FormatCurrency(subClaim.ExpenseReserve)</td>
                                        <td class="text-end font-monospace">@FormatCurrency(subClaim.ExpensePaid)</td>
                                        <td class="text-end font-monospace">@FormatCurrency(subClaim.IndemnityReserve)</td>
                                        <td class="text-end font-monospace">@FormatCurrency(subClaim.IndemnityPaid)</td>
                                        <td class="text-end font-monospace">@FormatCurrency(subClaim.Recoveries)</td>
                                        <td class="text-end font-monospace">@FormatCurrency(subClaim.Offset)</td>
                                        <td class="text-center">
                                            <span class="badge @GetStatusBadgeClass(subClaim.Status)">@subClaim.Status</span>
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="12" class="text-center text-muted py-5">
                                        <i class="bi bi-inbox display-4 d-block mb-3"></i>
                                        <p class="mb-2">No sub-claims/features found for this claim.</p>
                                        <small class="text-muted">
                                            Features are created during the FNOL process when injuries or third parties are added.
                                        </small>
                                    </td>
                                </tr>
                            }
                        </tbody>
                        @if (SubClaimsList.Any())
                        {
                            <tfoot class="table-secondary">
                                <tr class="fw-bold">
                                    <td colspan="5" class="text-end">Totals:</td>
                                    <td class="text-end font-monospace">@FormatCurrency(SubClaimsList.Sum(s => s.ExpenseReserve))</td>
                                    <td class="text-end font-monospace">@FormatCurrency(SubClaimsList.Sum(s => s.ExpensePaid))</td>
                                    <td class="text-end font-monospace">@FormatCurrency(SubClaimsList.Sum(s => s.IndemnityReserve))</td>
                                    <td class="text-end font-monospace">@FormatCurrency(SubClaimsList.Sum(s => s.IndemnityPaid))</td>
                                    <td class="text-end font-monospace">@FormatCurrency(SubClaimsList.Sum(s => s.Recoveries))</td>
                                    <td class="text-end font-monospace">@FormatCurrency(SubClaimsList.Sum(s => s.Offset))</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        }
                    </table>
                </div>
            </div>
        </div>

        <!-- Financial Summary Cards -->
        <div class="row mt-4">
            <div class="col-md-3">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h6 class="text-muted mb-1">Total Paid</h6>
                        <h4 class="text-primary mb-0">
                            @FormatCurrency(SubClaimsList.Sum(s => s.ExpensePaid + s.IndemnityPaid))
                        </h4>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h6 class="text-muted mb-1">Total Recovery</h6>
                        <h4 class="text-success mb-0">
                            @FormatCurrency(SubClaimsList.Sum(s => s.Recoveries))
                        </h4>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h6 class="text-muted mb-1">Total Offset</h6>
                        <h4 class="text-info mb-0">
                            @FormatCurrency(SubClaimsList.Sum(s => s.Offset))
                        </h4>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h6 class="text-muted mb-1">Total Reserves</h6>
                        <h4 class="text-warning mb-0">
                            @FormatCurrency(SubClaimsList.Sum(s => s.ExpenseReserve + s.IndemnityReserve))
                        </h4>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i> Claim not found or could not be loaded.
            <br/><small>CurrentClaim is null. Claim parameter: @(Claim == null ? "null" : "provided")</small>
        </div>
    }
</div>

<!-- Close/Reopen Feature Modal -->
<CloseReopenFeatureModal @ref="closeReopenModal" OnActionCompleted="HandleCloseReopenCompleted" />

<style>
    .subclaim-fullview .action-toolbar {
        position: sticky;
        top: 0;
        z-index: 100;
    }

    .subclaim-fullview .action-icon-group {
        min-width: 65px;
    }

    .subclaim-fullview .action-icon-group button {
        display: block;
        margin: 0 auto;
        text-decoration: none;
        transition: all 0.2s ease;
    }

    .subclaim-fullview .action-icon-group button:hover:not(:disabled) {
        transform: scale(1.15);
    }
    
    .subclaim-fullview .action-icon-group button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .subclaim-fullview .action-label {
        font-size: 0.7rem;
        font-weight: 500;
        color: #495057;
        white-space: nowrap;
        margin-top: 4px;
        line-height: 1.2;
    }

    .subclaim-fullview .subclaim-grid {
        font-size: 0.9rem;
    }

    .subclaim-fullview .subclaim-grid thead th {
        font-weight: 600;
        white-space: nowrap;
        vertical-align: middle;
    }

    .subclaim-fullview .subclaim-grid tbody td {
        vertical-align: middle;
    }

    .subclaim-fullview .selected-row {
        background-color: #cfe2ff !important;
    }

    .subclaim-fullview .font-monospace {
        font-family: 'Consolas', 'Monaco', monospace;
    }

    .subclaim-fullview .vr {
        width: 1px;
        height: 40px;
        background-color: #dee2e6;
    }
</style>

@code {
    /// <summary>
    /// The claim to display. If provided, the component uses this claim directly.
    /// </summary>
    [Parameter]
    public Models.Claim? Claim { get; set; }

    /// <summary>
    /// The claim number to load. If Claim is null, this will be used to load the claim from database.
    /// </summary>
    [Parameter]
    public string? ClaimNumber { get; set; }

    /// <summary>
    /// Callback when sub-claim status changes (for parent components to refresh).
    /// </summary>
    [Parameter]
    public EventCallback OnSubClaimStatusChanged { get; set; }

    [Inject]
    private IDatabaseClaimService DatabaseClaimService { get; set; } = null!;

    // Modal references
    private CloseReopenFeatureModal? closeReopenModal;

    // Internal state - use CurrentClaim to avoid null reference issues with parameter
    private Models.Claim? CurrentClaim { get; set; }
    private bool IsLoading { get; set; }
    private List<int> SelectedSubClaims { get; set; } = [];
    private bool IsProcessing { get; set; }
    private string StatusMessage { get; set; } = "";
    
    // Safe accessor for SubClaims list
    private List<Models.SubClaim> SubClaimsList => CurrentClaim?.SubClaims ?? new List<Models.SubClaim>();

    protected override void OnInitialized()
    {
        // CRITICAL: Set CurrentClaim immediately from Claim parameter on initialization
        // This ensures data is available for the first render
        if (Claim != null)
        {
            CurrentClaim = Claim;
            IsLoading = false;
            Console.WriteLine($"[SubClaimFullView] OnInitialized: Setting CurrentClaim from Claim parameter with {Claim.SubClaims?.Count ?? 0} sub-claims");
        }
    }

    protected override void OnParametersSet()
    {
        // Synchronously update CurrentClaim when Claim parameter changes
        if (Claim != null)
        {
            CurrentClaim = Claim;
            IsLoading = false;
            Console.WriteLine($"[SubClaimFullView] OnParametersSet: Claim received with {CurrentClaim?.SubClaims?.Count ?? 0} sub-claims");
        }
    }

    protected override async Task OnInitializedAsync()
    {
        // Only load from database if Claim was NOT provided as parameter
        if (Claim == null && !string.IsNullOrEmpty(ClaimNumber))
        {
            await LoadClaimFromDatabaseAsync();
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        // Only load from database if no Claim was passed as parameter
        if (Claim == null && !string.IsNullOrEmpty(ClaimNumber) && CurrentClaim == null)
        {
            await LoadClaimFromDatabaseAsync();
        }
    }

    private async Task LoadClaimFromDatabaseAsync()
    {
        if (string.IsNullOrEmpty(ClaimNumber))
            return;
            
        IsLoading = true;
        StateHasChanged();
        
        try
        {
            Console.WriteLine($"[SubClaimFullView] Loading claim from database: {ClaimNumber}");
            CurrentClaim = await DatabaseClaimService.GetClaimWithDetailsAsync(ClaimNumber);
            Console.WriteLine($"[SubClaimFullView] Loaded claim with {CurrentClaim?.SubClaims?.Count ?? 0} sub-claims");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[SubClaimFullView] Error loading claim: {ex.Message}");
            CurrentClaim = null;
        }
        finally
        {
            IsLoading = false;
        }
    }

    /// <summary>
    /// Refresh the claim data from the database.
    /// </summary>
    public async Task RefreshAsync()
    {
        var claimNum = ClaimNumber ?? CurrentClaim?.ClaimNumber;
        if (!string.IsNullOrEmpty(claimNum))
        {
            IsLoading = true;
            StateHasChanged();
            
            try
            {
                CurrentClaim = await DatabaseClaimService.GetClaimWithDetailsAsync(claimNum);
                SelectedSubClaims.Clear();
                StatusMessage = "";
            }
            catch (Exception ex)
            {
                Console.WriteLine($"[SubClaimFullView] Error refreshing claim: {ex.Message}");
            }
            finally
            {
                IsLoading = false;
                await InvokeAsync(StateHasChanged);
            }
        }
    }

    private void ToggleSelection(int id, bool isChecked)
    {
        StatusMessage = "";
        if (isChecked && !SelectedSubClaims.Contains(id))
        {
            SelectedSubClaims.Add(id);
        }
        else if (!isChecked)
        {
            SelectedSubClaims.Remove(id);
        }
    }

    private void SelectAll(ChangeEventArgs e)
    {
        StatusMessage = "";
        SelectedSubClaims.Clear();
        
        if ((bool)e.Value! && CurrentClaim != null)
        {
            SelectedSubClaims = SubClaimsList.Select(s => s.Id).ToList();
        }
    }

    private async Task ShowCloseModal()
    {
        if (!SelectedSubClaims.Any() || closeReopenModal == null)
            return;

        var selectedItems = SubClaimsList.Where(s => SelectedSubClaims.Contains(s.Id)).ToList();
        await closeReopenModal.ShowCloseAsync(selectedItems);
    }

    private async Task ShowReopenModal()
    {
        if (!SelectedSubClaims.Any() || closeReopenModal == null)
            return;

        var selectedItems = SubClaimsList.Where(s => SelectedSubClaims.Contains(s.Id)).ToList();
        await closeReopenModal.ShowReopenAsync(selectedItems);
    }

    private async Task HandleCloseReopenCompleted(CloseReopenFeatureModal.CloseReopenResult result)
    {
        if (result.Success)
        {
            // Update local status for immediate UI feedback
            foreach (var id in result.AffectedSubClaimIds)
            {
                var subClaim = SubClaimsList.FirstOrDefault(s => s.Id == id);
                if (subClaim != null)
                {
                    subClaim.Status = result.IsCloseOperation ? "Closed" : "Reopened";
                    
                    // Update reserves if closed
                    if (result.IsCloseOperation)
                    {
                        subClaim.ExpenseReserve = 0;
                        subClaim.IndemnityReserve = 0;
                    }
                }
            }
            
            StatusMessage = result.IsCloseOperation 
                ? $"Successfully closed {result.AffectedSubClaimIds.Count} feature(s)."
                : $"Successfully reopened {result.AffectedSubClaimIds.Count} feature(s).";
            
            SelectedSubClaims.Clear();
            
            // Refresh data from database
            await RefreshAsync();
            
            // Notify parent
            await OnSubClaimStatusChanged.InvokeAsync();
        }
    }

    private void PerformAction(string action)
    {
        if (!SelectedSubClaims.Any())
            return;

        Console.WriteLine($"Action: {action}, SubClaims: {string.Join(",", SelectedSubClaims)}");
        StatusMessage = $"{action} action will be implemented. Selected {SelectedSubClaims.Count} feature(s).";
    }

    private string FormatCurrency(decimal value)
    {
        return value.ToString("N2");
    }

    private string GetStatusBadgeClass(string status) => status switch
    {
        "Open" => "bg-success",
        "Closed" => "bg-secondary",
        "Reopened" => "bg-warning text-dark",
        _ => "bg-info"
    };

    private string GetClaimStatusBadgeClass(string status) => status switch
    {
        "Open" => "bg-success",
        "Closed" => "bg-secondary",
        "Reopened" => "bg-warning text-dark",
        "Draft" => "bg-warning text-dark",
        _ => "bg-info"
    };
}
