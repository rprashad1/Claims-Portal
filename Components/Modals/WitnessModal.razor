@using ClaimsPortal.Models
@using ClaimsPortal.Components.Shared

<div class="modal fade" id="witnessModal" tabindex="-1" role="dialog" aria-labelledby="witnessModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="witnessModalLabel">@(EditingWitness != null ? "Edit Witness" : "Add Witness")</h5>
                <button type="button" class="btn-close" @onclick="OnCancel" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Contact Information -->
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">Contact Information</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Name *</label>
                            <input type="text" class="form-control" @bind="CurrentWitness.Name" placeholder="Witness Name" />
                        </div>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" @bind="CurrentWitness.Email" placeholder="Witness Email" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Phone Number</label>
                                <input type="tel" class="form-control" value="@PhoneDisplay" 
                                       @onchange="OnPhoneChanged" placeholder="(555) 000-0000" />
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Address Information -->
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">Address Information</h6>
                    </div>
                    <div class="card-body">
                        <AddressTemplate 
                            @bind-StreetAddress="CurrentWitness.Address.StreetAddress"
                            @bind-AddressLine2="CurrentWitness.Address.AddressLine2"
                            @bind-City="CurrentWitness.Address.City"
                            @bind-State="CurrentWitness.Address.State"
                            @bind-ZipCode="CurrentWitness.Address.ZipCode"
                            Label1="Street Address"
                            Label2="Address Line 2" />
                    </div>
                </div>

                <!-- Identification -->
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">Identification</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-0">
                            <label class="form-label">FEIN/SS#</label>
                            <input type="text" class="form-control" @bind="CurrentWitness.FeinSsNumber" placeholder="FEIN or Social Security #" />
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" @onclick="OnCancel">Cancel</button>
                <button type="button" class="btn btn-primary" @onclick="OnAdd" disabled="@(!IsFormValid())">
                    @(EditingWitness != null ? "Update Witness" : "Add Witness")
                </button>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public EventCallback<Witness> OnWitnessAdded { get; set; }

    [Parameter]
    public EventCallback OnCancelled { get; set; }

    [Inject]
    private IJSRuntime JS { get; set; } = null!;

    private Witness CurrentWitness = new();
    private Witness? EditingWitness;
    private string PhoneDisplay = "";

    public async Task ShowAsync(Witness? witness = null)
    {
        EditingWitness = witness;
        if (witness != null)
        {
            CurrentWitness = new() 
            { 
                Id = witness.Id,
                Name = witness.Name,
                Email = witness.Email,
                PhoneNumber = witness.PhoneNumber,
                Address = witness.Address?.Copy() ?? new(),
                FeinSsNumber = witness.FeinSsNumber
            };
            PhoneDisplay = FormatPhoneNumber(CurrentWitness.PhoneNumber);
        }
        else
        {
            CurrentWitness = new();
            PhoneDisplay = "";
        }
        await JS.InvokeVoidAsync("ShowModal", "witnessModal");
    }

    private bool IsFormValid() => 
        !string.IsNullOrWhiteSpace(CurrentWitness.Name);  // ONLY Name is mandatory

    private async Task OnAdd()
    {
        if (IsFormValid())
        {
            if (CurrentWitness.Id == 0)
                CurrentWitness.Id = new Random().Next(1000, 9999);
            
            await OnWitnessAdded.InvokeAsync(CurrentWitness);
            await JS.InvokeVoidAsync("HideModal", "witnessModal");
        }
    }

    private async Task OnCancel()
    {
        await OnCancelled.InvokeAsync();
        await JS.InvokeVoidAsync("HideModal", "witnessModal");
    }

    private void OnPhoneChanged(ChangeEventArgs e)
    {
        var rawValue = e.Value?.ToString() ?? "";
        CurrentWitness.PhoneNumber = new string(rawValue.Where(char.IsDigit).ToArray());
        PhoneDisplay = FormatPhoneNumber(CurrentWitness.PhoneNumber);
    }

    private string FormatPhoneNumber(string? phone)
    {
        if (string.IsNullOrEmpty(phone))
            return "";
        
        var digits = new string(phone.Where(char.IsDigit).ToArray());
        
        if (digits.Length == 10)
            return string.Format("({0}) {1}-{2}", digits.Substring(0, 3), digits.Substring(3, 3), digits.Substring(6));
        else if (digits.Length == 11 && digits[0] == '1')
            return string.Format("+1 ({0}) {1}-{2}", digits.Substring(1, 3), digits.Substring(4, 3), digits.Substring(7));
        
        return phone;
    }
}
