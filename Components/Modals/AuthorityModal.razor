@using ClaimsPortal.Models
@using ClaimsPortal.Services
@inject IVendorSearchService VendorSearchService
@inject IJSRuntime JS

<div class="modal fade" id="authorityModal" tabindex="-1" role="dialog" aria-labelledby="authorityModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="authorityModalLabel">
                    <i class="bi bi-shield me-2"></i>@(EditingAuthority != null ? "Edit Authority" : "Add Authority")
                </h5>
                <button type="button" class="btn-close" @onclick="OnCancel" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Authority Type Selection -->
                <div class="mb-3">
                    <label class="form-label">Authority Type *</label>
                    <select class="form-select" @bind="SelectedAuthorityType" @bind:after="OnAuthorityTypeChanged">
                        <option value="">-- Select Authority Type --</option>
                        <option value="Police Department">Police Department</option>
                        <option value="Fire Station">Fire Station</option>
                    </select>
                </div>

                @if (!string.IsNullOrEmpty(SelectedAuthorityType))
                {
                    <!-- Search Vendor Section -->
                    <div class="card mb-3 border-primary">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">
                                <i class="bi bi-search me-2"></i>Search @SelectedAuthorityType from Vendor Master
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-2">
                                <div class="col-md-8">
                                    <input type="text" class="form-control" placeholder="Search by name..." 
                                           @bind="VendorSearchTerm" @bind:event="oninput" @onkeypress="HandleSearchKeyPress" />
                                </div>
                                <div class="col-md-4">
                                    <button type="button" class="btn btn-primary w-100" @onclick="SearchVendors" disabled="@IsSearching">
                                        @if (IsSearching)
                                        {
                                            <span class="spinner-border spinner-border-sm me-1"></span>
                                            <span>Searching...</span>
                                        }
                                        else
                                        {
                                            <i class="bi bi-search me-1"></i>
                                            <span>Search</span>
                                        }
                                    </button>
                                </div>
                            </div>

                            @if (HasSearched)
                            {
                                @if (VendorSearchResults.Count > 0)
                                {
                                    <div class="mt-3" style="max-height: 200px, overflow-y: auto;">
                                        <table class="table table-sm table-hover mb-0">
                                            <thead class="table-light sticky-top">
                                                <tr>
                                                    <th>Name</th>
                                                    <th>Address</th>
                                                    <th></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var vendor in VendorSearchResults)
                                                {
                                                    <tr>
                                                        <td>
                                                            <strong>@vendor.Name</strong>
                                                            @if (!string.IsNullOrEmpty(vendor.DoingBusinessAs))
                                                            {
                                                                <br /><small class="text-muted">DBA: @vendor.DoingBusinessAs</small>
                                                            }
                                                        </td>
                                                        <td>
                                                            <small>@vendor.GetShortAddress()</small>
                                                        </td>
                                                        <td>
                                                            <button type="button" class="btn btn-sm btn-success" @onclick="async () => await SelectVendor(vendor)">
                                                                <i class="bi bi-check-lg"></i> Select
                                                            </button>
                                                        </td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                }
                                else
                                {
                                    <div class="alert alert-info mt-3 mb-0">
                                        <i class="bi bi-info-circle me-2"></i>
                                        No @SelectedAuthorityType found in Vendor Master. You can enter the information manually below.
                                    </div>
                                }
                            }
                        </div>
                    </div>

                    <!-- Manual Entry Section -->
                    <div class="card @(SelectedVendorId.HasValue ? "border-success" : "")">
                        <div class="card-header @(SelectedVendorId.HasValue ? "bg-success text-white" : "")">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">
                                    @if (SelectedVendorId.HasValue)
                                    {
                                        <i class="bi bi-check-circle me-2"></i><span>Selected Authority</span>
                                    }
                                    else
                                    {
                                        <i class="bi bi-pencil me-2"></i><span>Enter Authority Information Manually</span>
                                    }
                                </h6>
                                @if (SelectedVendorId.HasValue)
                                {
                                    <button type="button" class="btn btn-sm btn-outline-light" @onclick="ClearSelectedVendor">
                                        <i class="bi bi-x-lg me-1"></i>Clear
                                    </button>
                                }
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Name/Agency Name *</label>
                                    <input type="text" class="form-control @(SelectedVendorId.HasValue ? "bg-light" : "")" 
                                           @bind="CurrentAuthority.Name" 
                                           @bind:after="CheckDuplicateAuthority"
                                           disabled="@SelectedVendorId.HasValue" 
                                           placeholder="e.g., Metro Police Department" />
                                    @if (ShowDuplicateWarning && DuplicateAuthorities.Count > 0)
                                    {
                                        <div class="alert alert-warning mt-2 py-2">
                                            <small>
                                                <i class="bi bi-exclamation-triangle me-1"></i>
                                                <strong>Similar authority found in Vendor Master:</strong>
                                            </small>
                                            <ul class="mb-0 mt-1">
                                                @foreach (var dup in DuplicateAuthorities.Take(3))
                                                {
                                                    <li>
                                                        <small>
                                                            <a href="#" @onclick="async () => await SelectDuplicateAuthority(dup)" @onclick:preventDefault>
                                                                @dup.Name - @dup.GetShortAddress()
                                                            </a>
                                                        </small>
                                                    </li>
                                                }
                                            </ul>
                                            <small class="text-muted d-block mt-1">
                                                Click to select, or continue to enter a new authority.
                                            </small>
                                        </div>
                                    }
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Report/Case Number</label>
                                    <input type="text" class="form-control" @bind="CurrentAuthority.ReportNumber" 
                                           placeholder="e.g., 2024-12345" />
                                </div>
                            </div>
                            
                            <!-- Address Fields using Address class -->
                            <div class="row g-3 mt-2">
                                <div class="col-md-12">
                                    <label class="form-label">Street Address</label>
                                    <input type="text" class="form-control @(SelectedVendorId.HasValue ? "bg-light" : "")" 
                                           @bind="CurrentAuthority.Address.StreetAddress" 
                                           disabled="@SelectedVendorId.HasValue" 
                                           placeholder="Street Address" />
                                </div>
                            </div>
                            <div class="row g-3 mt-2">
                                <div class="col-md-6">
                                    <label class="form-label">Address Line 2</label>
                                    <input type="text" class="form-control @(SelectedVendorId.HasValue ? "bg-light" : "")" 
                                           @bind="CurrentAuthority.Address.AddressLine2" 
                                           disabled="@SelectedVendorId.HasValue" 
                                           placeholder="Suite, Unit, etc." />
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">City</label>
                                    <input type="text" class="form-control @(SelectedVendorId.HasValue ? "bg-light" : "")" 
                                           @bind="CurrentAuthority.Address.City" 
                                           disabled="@SelectedVendorId.HasValue" 
                                           placeholder="City" />
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">State</label>
                                    <input type="text" class="form-control @(SelectedVendorId.HasValue ? "bg-light" : "")" 
                                           @bind="CurrentAuthority.Address.State" 
                                           disabled="@SelectedVendorId.HasValue" 
                                           placeholder="State" maxlength="2" />
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Zip Code</label>
                                    <input type="text" class="form-control @(SelectedVendorId.HasValue ? "bg-light" : "")" 
                                           @bind="CurrentAuthority.Address.ZipCode" 
                                           disabled="@SelectedVendorId.HasValue" 
                                           placeholder="Zip" />
                                </div>
                            </div>

                            @if (SelectedVendorId.HasValue)
                            {
                                <div class="alert alert-success mt-3 mb-0">
                                    <i class="bi bi-info-circle me-2"></i>
                                    Authority information loaded from Vendor Master. You can still add a report number above.
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" @onclick="OnCancel">
                    <i class="bi bi-x-lg me-1"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" @onclick="OnAdd" disabled="@(!IsFormValid())">
                    <i class="bi bi-check-lg me-1"></i>@(EditingAuthority != null ? "Update Authority" : "Add Authority")
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Duplicate vendor confirmation modal -->
<div class="modal fade" id="duplicateVendorModal" tabindex="-1" role="dialog" aria-labelledby="duplicateVendorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="duplicateVendorModalLabel">Similar Vendor(s) Found</h5>
                <button type="button" class="btn-close" @onclick="HideDuplicateModal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-2">A vendor with a similar name was found in Vendor Master. Select to use the existing vendor, or cancel to continue entering a new authority.</p>
                @if (DuplicateAuthorities.Count > 0)
                {
                    <div class="list-group">
                        @foreach (var dup in DuplicateAuthorities)
                        {
                            <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-start" @onclick="async () => await SelectVendor(dup)">
                                <div>
                                    <strong>@dup.Name</strong>
                                    <div><small class="text-muted">@dup.GetShortAddress()</small></div>
                                </div>
                                <div>
                                    <span class="badge bg-primary rounded-pill">Select</span>
                                </div>
                            </button>
                        }
                    </div>
                }
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" @onclick="HideDuplicateModal">Cancel</button>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public EventCallback<Authority> OnAuthorityAdded { get; set; }

    [Parameter]
    public EventCallback OnCancelled { get; set; }

    private Authority CurrentAuthority = new();
    private Authority? EditingAuthority;
    private string SelectedAuthorityType = "";
    private string VendorSearchTerm = "";
    private bool IsSearching = false;
    private bool HasSearched = false;
    private List<VendorSearchResult> VendorSearchResults = new();
    private long? SelectedVendorId;
    
    // Duplicate detection
    private bool ShowDuplicateWarning = false;
    private List<VendorSearchResult> DuplicateAuthorities = new();
    private System.Timers.Timer? duplicateCheckTimer;

    protected override void OnInitialized()
    {
        // Setup debounce timer for duplicate check
        duplicateCheckTimer = new System.Timers.Timer(500);
        duplicateCheckTimer.AutoReset = false;
        duplicateCheckTimer.Elapsed += async (s, e) => await InvokeAsync(PerformDuplicateCheck);
    }

    public async Task ShowAsync(Authority? authority = null)
    {
        EditingAuthority = authority;
        if (authority != null)
        {
            CurrentAuthority = new() 
            { 
                Id = authority.Id,
                AuthorityName = authority.AuthorityName,
                Name = authority.Name,
                Address = authority.Address?.Copy() ?? new(),
                ReportNumber = authority.ReportNumber
            };
            SelectedAuthorityType = authority.AuthorityName;
        }
        else
        {
            CurrentAuthority = new();
            SelectedAuthorityType = "";
            VendorSearchTerm = "";
            HasSearched = false;
            VendorSearchResults = new();
            SelectedVendorId = null;
            ShowDuplicateWarning = false;
            DuplicateAuthorities.Clear();
        }
        await JS.InvokeVoidAsync("ShowModal", "authorityModal");
    }

    private void OnAuthorityTypeChanged()
    {
        CurrentAuthority.AuthorityName = SelectedAuthorityType;
        // Reset search when type changes
        VendorSearchTerm = "";
        HasSearched = false;
        VendorSearchResults = new();
        SelectedVendorId = null;
        CurrentAuthority.Name = "";
        CurrentAuthority.Address = new();
        CurrentAuthority.ReportNumber = "";
        ShowDuplicateWarning = false;
        DuplicateAuthorities.Clear();
    }

    private async Task HandleSearchKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SearchVendors();
        }
    }

    private async Task SearchVendors()
    {
        if (string.IsNullOrWhiteSpace(SelectedAuthorityType))
            return;

        try
        {
            IsSearching = true;
            HasSearched = true;

            VendorSearchResults = await VendorSearchService.SearchAuthoritiesAsync(
                VendorSearchTerm, 
                SelectedAuthorityType, 
                10);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error searching vendors: {ex.Message}");
            VendorSearchResults = new();
        }
        finally
        {
            IsSearching = false;
        }
    }

    private async Task SelectVendor(VendorSearchResult vendor)
    {
        // Set VendorId (use VendorId for linking) and populate name/address
        CurrentAuthority.VendorId = vendor.VendorId;
        SelectedVendorId = vendor.VendorId;
        CurrentAuthority.Name = vendor.Name;
        CurrentAuthority.Address = new Address
        {
            StreetAddress = vendor.StreetAddress ?? "",
            AddressLine2 = vendor.AddressLine2 ?? "",
            City = vendor.City ?? "",
            State = vendor.State ?? "",
            ZipCode = vendor.ZipCode ?? ""
        };
        ShowDuplicateWarning = false;
        DuplicateAuthorities.Clear();

        // Hide duplicate modal if open
        await JS.InvokeVoidAsync("HideModal", "duplicateVendorModal");
        await InvokeAsync(StateHasChanged);
    }

    private void ClearSelectedVendor()
    {
        SelectedVendorId = null;
        CurrentAuthority.Name = "";
        CurrentAuthority.Address = new();
    }

    private void CheckDuplicateAuthority()
    {
        if (SelectedVendorId.HasValue)
            return;
        
        // Debounce - reset timer
        duplicateCheckTimer?.Stop();
        duplicateCheckTimer?.Start();
    }

    private async Task PerformDuplicateCheck()
    {
        if (SelectedVendorId.HasValue)
            return;
        
        if (string.IsNullOrWhiteSpace(CurrentAuthority.Name) || CurrentAuthority.Name.Length < 3)
        {
            ShowDuplicateWarning = false;
            DuplicateAuthorities.Clear();
            await InvokeAsync(StateHasChanged);
            return;
        }

        try
        {
            DuplicateAuthorities = await VendorSearchService.SearchAuthoritiesAsync(
                CurrentAuthority.Name, 
                SelectedAuthorityType, 
                5);
            ShowDuplicateWarning = DuplicateAuthorities.Count > 0;
            // If duplicates found, prompt user with modal to select
            if (DuplicateAuthorities.Count > 0)
            {
                await InvokeAsync(StateHasChanged);
                await JS.InvokeVoidAsync("ShowModal", "duplicateVendorModal");
            }
            else
            {
                await InvokeAsync(StateHasChanged);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error checking duplicate authority: {ex.Message}");
        }
    }

    private async Task SelectDuplicateAuthority(VendorSearchResult vendor)
    {
        await SelectVendor(vendor);
    }

    private async Task HideDuplicateModal()
    {
        await JS.InvokeVoidAsync("HideModal", "duplicateVendorModal");
    }

    private async Task ShowDuplicateModal()
    {
        await JS.InvokeVoidAsync("ShowModal", "duplicateVendorModal");
    }

    private bool IsFormValid() => 
        !string.IsNullOrWhiteSpace(SelectedAuthorityType) &&
        !string.IsNullOrWhiteSpace(CurrentAuthority.Name);

    private async Task OnAdd()
    {
        if (IsFormValid())
        {
            if (CurrentAuthority.Id == 0)
                CurrentAuthority.Id = new Random().Next(1000, 9999);
            
            // Pass VendorId if authority was selected from vendor master
            await OnAuthorityAdded.InvokeAsync(CurrentAuthority);
            await JS.InvokeVoidAsync("HideModal", "authorityModal");
        }
    }

    private async Task OnCancel()
    {
        await OnCancelled.InvokeAsync();
        await JS.InvokeVoidAsync("HideModal", "authorityModal");
    }

    public void Dispose()
    {
        duplicateCheckTimer?.Dispose();
    }
}
