@using ClaimsPortal.Models
@using ClaimsPortal.Services

<div class="modal fade" id="closeReopenFeatureModal" tabindex="-1" role="dialog" aria-labelledby="closeReopenFeatureModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header @(IsCloseOperation ? "bg-danger" : "bg-success") text-white">
                <h5 class="modal-title" id="closeReopenFeatureModalLabel">
                    @if (IsCloseOperation)
                    {
                        <i class="bi bi-x-circle me-2"></i>
                        <span>Close Feature</span>
                    }
                    else
                    {
                        <i class="bi bi-arrow-counterclockwise me-2"></i>
                        <span>Reopen Feature</span>
                    }
                </h5>
                <button type="button" class="btn-close btn-close-white" @onclick="CloseModal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                @if (IsLoading)
                {
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Loading reasons...</p>
                    </div>
                }
                else if (IsProcessing)
                {
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Processing...</span>
                        </div>
                        <p class="mt-2 text-muted">@(IsCloseOperation ? "Closing" : "Reopening") feature(s)...</p>
                    </div>
                }
                else if (ShowSuccess)
                {
                    <div class="text-center py-5">
                        <i class="bi @(IsCloseOperation ? "bi-check-circle text-danger" : "bi-arrow-counterclockwise text-success")" style="font-size: 4rem;"></i>
                        <h4 class="mt-3">@(IsCloseOperation ? "Feature Closed Successfully" : "Feature Reopened Successfully")</h4>
                        <p class="text-muted">@SuccessMessage</p>
                        <button type="button" class="btn btn-primary mt-3" @onclick="CloseModalAndNotify">
                            <i class="bi bi-check"></i> OK
                        </button>
                    </div>
                }
                else
                {
                    <!-- Selected Features Summary -->
                    <div class="alert @(IsCloseOperation ? "alert-warning" : "alert-info") mb-4">
                        <h6 class="mb-2">
                            <i class="bi bi-info-circle me-1"></i>
                            @(SelectedSubClaims.Count) Feature(s) Selected
                        </h6>
                        <div class="small">
                            @foreach (var sc in SelectedSubClaims)
                            {
                                <span class="badge bg-primary me-1 mb-1">
                                    Feature @sc.FeatureNumber - @sc.Coverage (@sc.ClaimantName)
                                </span>
                            }
                        </div>
                    </div>

                    @if (IsCloseOperation)
                    {
                        <!-- Close Feature Form -->
                        <div class="mb-4">
                            <label class="form-label"><strong>Close Reason *</strong></label>
                            <select class="form-select" @bind="SelectedReason">
                                <option value="">-- Select Close Reason --</option>
                                @foreach (var reason in CloseReasons)
                                {
                                    <option value="@reason">@reason</option>
                                }
                            </select>
                            @if (!CloseReasons.Any())
                            {
                                <small class="text-muted">No close reasons available. Please run the database migration script.</small>
                            }
                        </div>

                        <div class="alert alert-danger mb-3">
                            <i class="bi bi-exclamation-triangle me-1"></i>
                            <strong>Warning:</strong> Closing this feature will set both Expense Reserve and Indemnity Reserve to $0.00.
                        </div>

                        <!-- Current Reserves Display -->
                        <div class="card mb-4 bg-light">
                            <div class="card-header">
                                <h6 class="mb-0">Current Reserves (will be set to $0.00)</h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-sm mb-0">
                                        <thead>
                                            <tr>
                                                <th>Feature</th>
                                                <th>Coverage</th>
                                                <th class="text-end">Expense Reserve</th>
                                                <th class="text-end">Indemnity Reserve</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var sc in SelectedSubClaims)
                                            {
                                                <tr>
                                                    <td><span class="badge bg-primary">@sc.FeatureNumber</span></td>
                                                    <td>@sc.Coverage</td>
                                                    <td class="text-end font-monospace">@sc.ExpenseReserve.ToString("C2")</td>
                                                    <td class="text-end font-monospace">@sc.IndemnityReserve.ToString("C2")</td>
                                                </tr>
                                            }
                                        </tbody>
                                        <tfoot class="table-secondary">
                                            <tr class="fw-bold">
                                                <td colspan="2">Total</td>
                                                <td class="text-end font-monospace">@SelectedSubClaims.Sum(s => s.ExpenseReserve).ToString("C2")</td>
                                                <td class="text-end font-monospace">@SelectedSubClaims.Sum(s => s.IndemnityReserve).ToString("C2")</td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                    }
                    else
                    {
                        <!-- Reopen Feature Form -->
                        <div class="mb-4">
                            <label class="form-label"><strong>Reopen Reason *</strong></label>
                            <select class="form-select" @bind="SelectedReason">
                                <option value="">-- Select Reopen Reason --</option>
                                @foreach (var reason in ReopenReasons)
                                {
                                    <option value="@reason">@reason</option>
                                }
                            </select>
                            @if (!ReopenReasons.Any())
                            {
                                <small class="text-muted">No reopen reasons available. Please run the database migration script.</small>
                            }
                        </div>

                        <!-- Reserve Options -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">Reserve Options</h6>
                            </div>
                            <div class="card-body">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" name="reserveOption" id="reserveZero" 
                                           value="zero" checked="@(ReserveOption == "zero")" @onchange="@(() => ReserveOption = "zero")" />
                                    <label class="form-check-label" for="reserveZero">
                                        Keep reserves at $0.00
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" name="reserveOption" id="reservePrevious" 
                                           value="previous" checked="@(ReserveOption == "previous")" @onchange="@(() => ReserveOption = "previous")" />
                                    <label class="form-check-label" for="reservePrevious">
                                        Restore to previous reserve values before closing
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="reserveOption" id="reserveDefault" 
                                           value="default" checked="@(ReserveOption == "default")" @onchange="@(() => ReserveOption = "default")" />
                                    <label class="form-check-label" for="reserveDefault">
                                        Set to default values (Expense: $500.00, Indemnity: $1,500.00)
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Show previous reserves if available -->
                        @if (ReserveOption == "previous" && SelectedSubClaims.Any())
                        {
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-1"></i>
                                Reserves will be restored to their values before the feature was closed.
                            </div>
                        }
                    }

                    <!-- Remarks -->
                    <div class="mb-4">
                        <label class="form-label"><strong>Remarks</strong></label>
                        <textarea class="form-control" rows="4" @bind="Remarks" 
                                  placeholder="Enter any additional notes or remarks..."></textarea>
                    </div>

                    @if (!string.IsNullOrEmpty(ErrorMessage))
                    {
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle me-1"></i>
                            @ErrorMessage
                        </div>
                    }
                }
            </div>
            @if (!IsLoading && !IsProcessing && !ShowSuccess)
            {
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseModal">
                        <i class="bi bi-x"></i> Cancel
                    </button>
                    <button type="button" class="btn @(IsCloseOperation ? "btn-danger" : "btn-success")" 
                            @onclick="SubmitAction" disabled="@(!IsFormValid)">
                        @if (IsCloseOperation)
                        {
                            <i class="bi bi-x-circle me-1"></i>
                            <span>Close Feature</span>
                        }
                        else
                        {
                            <i class="bi bi-arrow-counterclockwise me-1"></i>
                            <span>Reopen Feature</span>
                        }
                    </button>
                </div>
            }
        </div>
    </div>
</div>

@code {
    [Parameter]
    public EventCallback<CloseReopenResult> OnActionCompleted { get; set; }

    [Inject]
    private IJSRuntime JS { get; set; } = null!;

    [Inject]
    private IDatabaseClaimService DatabaseClaimService { get; set; } = null!;

    [Inject]
    private DatabaseLookupService LookupService { get; set; } = null!;

    // State
    private List<Models.SubClaim> SelectedSubClaims { get; set; } = [];
    private bool IsCloseOperation { get; set; } = true;
    private bool IsLoading { get; set; }
    private bool IsProcessing { get; set; }
    private bool ShowSuccess { get; set; }
    private string SuccessMessage { get; set; } = "";
    private string ErrorMessage { get; set; } = "";

    // Form fields
    private string SelectedReason { get; set; } = "";
    private string Remarks { get; set; } = "";
    private string ReserveOption { get; set; } = "zero";

    // Dropdown options loaded from database
    private List<string> CloseReasons { get; set; } = [];
    private List<string> ReopenReasons { get; set; } = [];

    // Store the result to pass after modal closes
    private CloseReopenResult? PendingResult { get; set; }

    private bool IsFormValid => !string.IsNullOrEmpty(SelectedReason);

    /// <summary>
    /// Load lookup codes from the database
    /// </summary>
    private async Task LoadLookupCodesAsync()
    {
        IsLoading = true;
        StateHasChanged();
        
        try
        {
            // Try to load from database
            var closeReasonCodes = await LookupService.GetCloseReasonsAsync();
            var reopenReasonCodes = await LookupService.GetReopenReasonsAsync();

            // Extract descriptions for dropdown display
            CloseReasons = closeReasonCodes
                .Select(r => r.RecordDescription ?? r.RecordCode ?? "")
                .Where(r => !string.IsNullOrEmpty(r))
                .ToList();

            ReopenReasons = reopenReasonCodes
                .Select(r => r.RecordDescription ?? r.RecordCode ?? "")
                .Where(r => !string.IsNullOrEmpty(r))
                .ToList();

            Console.WriteLine($"Loaded {CloseReasons.Count} close reasons and {ReopenReasons.Count} reopen reasons from database");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading lookup codes from database: {ex.Message}");
            CloseReasons = [];
            ReopenReasons = [];
        }

        // Always apply fallback defaults if no reasons were loaded
        if (!CloseReasons.Any())
        {
            Console.WriteLine("Using fallback close reasons");
            CloseReasons =
            [
                "Below Deductible",
                "Open in Error",
                "Close with Negotiation",
                "Close with Payment",
                "Coverage Denial",
                "Insured Request",
                "Lack of Interest"
            ];
        }

        if (!ReopenReasons.Any())
        {
            Console.WriteLine("Using fallback reopen reasons");
            ReopenReasons =
            [
                "Additional Payment Required",
                "Close in Error",
                "New Claimant to be added",
                "Subrogation",
                "Litigation"
            ];
        }

        IsLoading = false;
        StateHasChanged();
    }

    /// <summary>
    /// Show the modal for closing features
    /// </summary>
    public async Task ShowCloseAsync(List<Models.SubClaim> subClaims)
    {
        ResetForm();
        SelectedSubClaims = subClaims;
        IsCloseOperation = true;
        StateHasChanged();
        
        await LoadLookupCodesAsync();
        await JS.InvokeVoidAsync("ShowModal", "closeReopenFeatureModal");
    }

    /// <summary>
    /// Show the modal for reopening features
    /// </summary>
    public async Task ShowReopenAsync(List<Models.SubClaim> subClaims)
    {
        ResetForm();
        SelectedSubClaims = subClaims;
        IsCloseOperation = false;
        StateHasChanged();
        
        await LoadLookupCodesAsync();
        await JS.InvokeVoidAsync("ShowModal", "closeReopenFeatureModal");
    }

    private void ResetForm()
    {
        SelectedReason = "";
        Remarks = "";
        ReserveOption = "zero";
        ErrorMessage = "";
        ShowSuccess = false;
        IsProcessing = false;
        IsLoading = false;
        PendingResult = null;
    }

    private async Task SubmitAction()
    {
        if (!IsFormValid)
        {
            ErrorMessage = "Please select a reason.";
            return;
        }

        IsProcessing = true;
        ErrorMessage = "";
        StateHasChanged();

        try
        {
            PendingResult = new CloseReopenResult
            {
                Success = true,
                IsCloseOperation = IsCloseOperation,
                Reason = SelectedReason,
                Remarks = Remarks,
                AffectedSubClaimIds = SelectedSubClaims.Select(s => s.Id).ToList()
            };

            foreach (var subClaim in SelectedSubClaims)
            {
                if (IsCloseOperation)
                {
                    // Close the feature
                    await DatabaseClaimService.CloseSubClaimWithDetailsAsync(
                        subClaim.Id,
                        SelectedReason,
                        Remarks,
                        "current_user" // TODO: Get actual user
                    );
                }
                else
                {
                    // Determine reserve values based on option
                    decimal expenseReserve = 0;
                    decimal indemnityReserve = 0;

                    if (ReserveOption == "default")
                    {
                        expenseReserve = 500m;
                        indemnityReserve = 1500m;
                    }
                    else if (ReserveOption == "previous")
                    {
                        // Get previous reserves from audit trail
                        var previousReserves = await DatabaseClaimService.GetPreviousReservesAsync(subClaim.Id);
                        expenseReserve = previousReserves.ExpenseReserve;
                        indemnityReserve = previousReserves.IndemnityReserve;
                    }
                    // else ReserveOption == "zero" -> keep 0

                    // Reopen the feature
                    await DatabaseClaimService.ReopenSubClaimWithDetailsAsync(
                        subClaim.Id,
                        SelectedReason,
                        Remarks,
                        expenseReserve,
                        indemnityReserve,
                        "current_user" // TODO: Get actual user
                    );
                }
            }

            ShowSuccess = true;
            SuccessMessage = IsCloseOperation
                ? $"{SelectedSubClaims.Count} feature(s) have been closed. Reserves set to $0.00."
                : $"{SelectedSubClaims.Count} feature(s) have been reopened.";
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error: {ex.Message}";
            PendingResult = null;
        }
        finally
        {
            IsProcessing = false;
            StateHasChanged();
        }
    }

    /// <summary>
    /// Close modal and notify parent of success
    /// </summary>
    private async Task CloseModalAndNotify()
    {
        await JS.InvokeVoidAsync("HideModal", "closeReopenFeatureModal");
        
        // Small delay to ensure modal is hidden before callback
        await Task.Delay(100);
        
        if (PendingResult != null)
        {
            await OnActionCompleted.InvokeAsync(PendingResult);
        }
        
        ResetForm();
    }

    /// <summary>
    /// Close modal without notification (for Cancel button)
    /// </summary>
    private async Task CloseModal()
    {
        await JS.InvokeVoidAsync("HideModal", "closeReopenFeatureModal");
        ResetForm();
    }

    /// <summary>
    /// Result of the close/reopen operation
    /// </summary>
    public class CloseReopenResult
    {
        public bool Success { get; set; }
        public bool IsCloseOperation { get; set; }
        public string Reason { get; set; } = "";
        public string Remarks { get; set; } = "";
        public List<int> AffectedSubClaimIds { get; set; } = [];
    }
}
