@using ClaimsPortal.Models
@using ClaimsPortal.Components.Shared
@using ClaimsPortal.Services
@inject IVendorService VendorService

<div class="modal fade" id="passengerModal" tabindex="-1" role="dialog" aria-labelledby="passengerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="passengerModalLabel">@(IsEditMode ? "Edit Passenger" : "Add Passenger")</h5>
                <button type="button" class="btn-close" @onclick="OnCancel" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Passenger Info -->
                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Passenger Name *</label>
                        <input type="text" class="form-control" @bind="Passenger.Name" placeholder="Full Name" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Phone Number</label>
                        <input type="tel" class="form-control" value="@PassengerPhoneDisplay" 
                               @onchange="OnPassengerPhoneChanged" placeholder="(555) 000-0000" />
                    </div>
                </div>
                
                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" @bind="Passenger.Email" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">FEIN/SS# <small class="text-muted">(Optional)</small></label>
                        <input type="text" class="form-control" @bind="Passenger.FeinSsNumber" placeholder="Optional" />
                    </div>
                </div>

                <!-- Address Information -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">Address Information</h6>
                    </div>
                    <div class="card-body">
                        <AddressTemplate 
                            @bind-StreetAddress="Passenger.Address.StreetAddress"
                            @bind-AddressLine2="Passenger.Address.AddressLine2"
                            @bind-City="Passenger.Address.City"
                            @bind-State="Passenger.Address.State"
                            @bind-ZipCode="Passenger.Address.ZipCode"
                            Label1="Street Address"
                            Label2="Address Line 2" />
                    </div>
                </div>

                <!-- Injury Status -->
                <div class="mb-4">
                    <label class="form-label">Was the passenger injured?</label>
                    <div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="passengerInjured" id="passengerInjuredYes" 
                                   value="true" checked="@Passenger.WasInjured"
                                   @onchange="@((ChangeEventArgs e) => SetInjured(true))" />
                            <label class="form-check-label" for="passengerInjuredYes">Yes</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="passengerInjured" id="passengerInjuredNo" 
                                   value="false" checked="@(!Passenger.WasInjured)"
                                   @onchange="@((ChangeEventArgs e) => SetInjured(false))" />
                            <label class="form-check-label" for="passengerInjuredNo">No</label>
                        </div>
                    </div>
                </div>

                <!-- Injury Information (if injured) -->
                @if (Passenger.WasInjured)
                {
                    <div class="alert alert-warning mb-3">
                        <i class="bi bi-exclamation-circle"></i> A feature/sub-claim will be created for this injury after you save.
                    </div>

                    <div class="mb-4">
                        <InjuryTemplateUnified @bind-InjuryInfo="Passenger.InjuryInfo" />
                    </div>
                }

                <!-- Attorney Representation -->
                <div class="mb-4">
                    <label class="form-label">Is the passenger represented by an attorney?</label>
                    <div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="passengerAttorney" id="passengerAttorneyYes" 
                                   value="true" checked="@Passenger.HasAttorney"
                                   @onchange="@((ChangeEventArgs e) => SetHasAttorney(true))" />
                            <label class="form-check-label" for="passengerAttorneyYes">Yes</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="passengerAttorney" id="passengerAttorneyNo" 
                                   value="false" checked="@(!Passenger.HasAttorney)"
                                   @onchange="@((ChangeEventArgs e) => SetHasAttorney(false))" />
                            <label class="form-check-label" for="passengerAttorneyNo">No</label>
                        </div>
                    </div>
                </div>

                <!-- Attorney Information (if represented) -->
                @if (Passenger.HasAttorney)
                {
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">Attorney Information</h6>
                                <button type="button" class="btn btn-sm btn-outline-primary" @onclick="SearchAttorney">
                                    <i class="bi bi-search me-1"></i>Search from Vendor Master
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            @if (SelectedAttorneyVendor != null)
                            {
                                <div class="alert alert-success mb-3">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <i class="bi bi-check-circle me-2"></i>
                                            <strong>Attorney loaded from Vendor Master:</strong> @SelectedAttorneyVendor.Name
                                        </div>
                                        <button type="button" class="btn btn-sm btn-outline-danger" @onclick="ClearSelectedAttorney">
                                            <i class="bi bi-x-lg"></i>
                                        </button>
                                    </div>
                                </div>
                            }

                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Attorney Name</label>
                                     <input type="text" class="form-control" @bind="Passenger.AttorneyInfo!.Name" 
                                           disabled="@(SelectedAttorneyVendor != null)" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Firm Name</label>
                                     <input type="text" class="form-control" @bind="Passenger.AttorneyInfo!.FirmName" 
                                           disabled="@(SelectedAttorneyVendor != null)" />
                                </div>
                            </div>

                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Phone Number</label>
                                    <input type="tel" class="form-control" value="@AttorneyPhoneDisplay" 
                                           @onchange="OnAttorneyPhoneChanged" placeholder="(555) 000-0000"
                                           disabled="@(SelectedAttorneyVendor != null)" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Email</label>
                                           <input type="email" class="form-control" @bind="Passenger.AttorneyInfo!.Email" 
                                           disabled="@(SelectedAttorneyVendor != null)" />
                                </div>
                            </div>

                            <!-- Attorney Address -->
                            @if (SelectedAttorneyVendor != null)
                            {
                                <div class="row g-3 mb-3">
                                    <div class="col-md-12">
                                        <label class="form-label">Street Address</label>
                                        <input type="text" class="form-control" value="@Passenger.AttorneyInfo!.Address.StreetAddress" disabled />
                                    </div>
                                </div>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Address Line 2</label>
                                        <input type="text" class="form-control" value="@Passenger.AttorneyInfo!.Address.AddressLine2" disabled />
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">City</label>
                                        <input type="text" class="form-control" value="@Passenger.AttorneyInfo!.Address.City" disabled />
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">State</label>
                                        <input type="text" class="form-control" value="@Passenger.AttorneyInfo!.Address.State" disabled />
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">Zip Code</label>
                                        <input type="text" class="form-control" value="@Passenger.AttorneyInfo!.Address.ZipCode" disabled />
                                    </div>
                                </div>
                            }
                            else
                            {
                                <AddressTemplate 
                                    @bind-StreetAddress="Passenger.AttorneyInfo!.Address.StreetAddress"
                                    @bind-AddressLine2="Passenger.AttorneyInfo!.Address.AddressLine2"
                                    @bind-City="Passenger.AttorneyInfo!.Address.City"
                                    @bind-State="Passenger.AttorneyInfo!.Address.State"
                                    @bind-ZipCode="Passenger.AttorneyInfo!.Address.ZipCode"
                                    Label1="Street Address"
                                    Label2="Address Line 2" />
                            }
                        </div>
                    </div>
                }
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" @onclick="OnCancel">Cancel</button>
                @if (Passenger.WasInjured)
                {
                    <button type="button" class="btn btn-primary" @onclick="OnAdd" disabled="@(!IsFormValid())">
                        <i class="bi bi-check-circle"></i> @(IsEditMode ? "Save Changes" : "Save & Create Feature")
                    </button>
                }
                else
                {
                    <button type="button" class="btn btn-success" @onclick="OnAdd" disabled="@(!IsFormValid())">
                        <i class="bi bi-check-circle"></i> @(IsEditMode ? "Save Changes" : "Save Passenger")
                    </button>
                }
            </div>
        </div>
    </div>
</div>

<!-- Attorney Search Modal -->
<AttorneySearchModal @ref="attorneySearchModal" 
                     ModalId="passengerAttorneySearchModal"
                     OnAttorneySelected="OnAttorneySelected" 
                     OnManualEntry="OnAttorneyManualEntry"
                     OnCancelled="@(() => {})" />

@code {
    [Parameter]
    public EventCallback<InsuredPassenger> OnPassengerAdded { get; set; }

    [Parameter]
    public EventCallback OnCancelled { get; set; }

    [Parameter]
    public List<string> NatureOfInjuries { get; set; } = [];

    [Inject]
    private IJSRuntime JS { get; set; } = null!;

    private InsuredPassenger Passenger = new();
    private AttorneySearchModal? attorneySearchModal;
    private Vendor? SelectedAttorneyVendor;
    private bool IsEditMode = false;
    
    // Phone display fields
    private string PassengerPhoneDisplay = "";
    private string AttorneyPhoneDisplay = "";

    public async Task ShowAsync()
    {
        IsEditMode = false;
        // IMPORTANT: Create a completely new Passenger object with all nested objects initialized
        Passenger = new InsuredPassenger
        {
            Name = "",
            PhoneNumber = "",
            Email = "",
            FeinSsNumber = "",
            WasInjured = false,
            HasAttorney = false,
            Address = new Address(),
            InjuryInfo = new Injury(),
            AttorneyInfo = new AttorneyInfo { Address = new Address() }
        };
        
        PassengerPhoneDisplay = "";
        AttorneyPhoneDisplay = "";
        SelectedAttorneyVendor = null;
        
        await JS.InvokeVoidAsync("ShowModal", "passengerModal");
    }

    public async Task ShowAsync(InsuredPassenger passengerToEdit)
    {
        IsEditMode = true;
        
        // Create a copy of the passenger for editing
        Passenger = new InsuredPassenger
        {
            Name = passengerToEdit.Name,
            PhoneNumber = passengerToEdit.PhoneNumber,
            Email = passengerToEdit.Email,
            FeinSsNumber = passengerToEdit.FeinSsNumber,
            WasInjured = passengerToEdit.WasInjured,
            HasAttorney = passengerToEdit.HasAttorney,
            Address = passengerToEdit.Address != null ? new Address
            {
                StreetAddress = passengerToEdit.Address.StreetAddress,
                AddressLine2 = passengerToEdit.Address.AddressLine2,
                City = passengerToEdit.Address.City,
                State = passengerToEdit.Address.State,
                ZipCode = passengerToEdit.Address.ZipCode
            } : new Address(),
            InjuryInfo = passengerToEdit.InjuryInfo != null ? new Injury
            {
                InjuryType = passengerToEdit.InjuryInfo.InjuryType,
                InjuryDescription = passengerToEdit.InjuryInfo.InjuryDescription,
                SeverityLevel = passengerToEdit.InjuryInfo.SeverityLevel,
                IsFatality = passengerToEdit.InjuryInfo.IsFatality,
                WasTakenToHospital = passengerToEdit.InjuryInfo.WasTakenToHospital,
                HospitalName = passengerToEdit.InjuryInfo.HospitalName,
                TreatingPhysician = passengerToEdit.InjuryInfo.TreatingPhysician
            } : new Injury(),
            AttorneyInfo = passengerToEdit.AttorneyInfo != null ? new AttorneyInfo
            {
                Name = passengerToEdit.AttorneyInfo.Name,
                FirmName = passengerToEdit.AttorneyInfo.FirmName,
                PhoneNumber = passengerToEdit.AttorneyInfo.PhoneNumber,
                Email = passengerToEdit.AttorneyInfo.Email,
                Address = passengerToEdit.AttorneyInfo.Address != null ? new Address
                {
                    StreetAddress = passengerToEdit.AttorneyInfo.Address.StreetAddress,
                    AddressLine2 = passengerToEdit.AttorneyInfo.Address.AddressLine2,
                    City = passengerToEdit.AttorneyInfo.Address.City,
                    State = passengerToEdit.AttorneyInfo.Address.State,
                    ZipCode = passengerToEdit.AttorneyInfo.Address.ZipCode
                } : new Address()
            } : new AttorneyInfo { Address = new Address() }
        };
        
        PassengerPhoneDisplay = FormatPhoneNumber(Passenger.PhoneNumber);
        AttorneyPhoneDisplay = FormatPhoneNumber(Passenger.AttorneyInfo?.PhoneNumber);
        SelectedAttorneyVendor = null;
        
        await JS.InvokeVoidAsync("ShowModal", "passengerModal");
    }

    private void SetInjured(bool injured)
    {
        Passenger.WasInjured = injured;
        
        // IMPORTANT: Always ensure InjuryInfo is initialized when setting injured to true
        // This fixes the bug where the injury fields don't appear when reopening the modal
        if (injured)
        {
            if (Passenger.InjuryInfo == null)
            {
                Passenger.InjuryInfo = new Injury();
            }
        }
        else
        {
            // Reset injury info when not injured, but keep object initialized
            Passenger.InjuryInfo = new Injury();
        }
        
        StateHasChanged();
    }

    private void SetHasAttorney(bool hasAttorney)
    {
        Passenger.HasAttorney = hasAttorney;
        if (!hasAttorney)
        {
            Passenger.AttorneyInfo = new AttorneyInfo { Address = new Address() };
            SelectedAttorneyVendor = null;
            AttorneyPhoneDisplay = "";
        }
        else if (Passenger.AttorneyInfo == null)
        {
            Passenger.AttorneyInfo = new AttorneyInfo { Address = new Address() };
        }
        
        StateHasChanged();
    }

    private async Task SearchAttorney()
    {
        if (attorneySearchModal != null)
        {
            await attorneySearchModal.ShowAsync();
        }
    }

    private void OnAttorneySelected(AttorneyInfo attorneyInfo)
    {
        Passenger.AttorneyInfo = attorneyInfo;
        SelectedAttorneyVendor = new Vendor { Name = attorneyInfo.FirmName };
        AttorneyPhoneDisplay = FormatPhoneNumber(attorneyInfo.PhoneNumber);
        StateHasChanged();
    }

    private void OnAttorneyManualEntry()
    {
        // User chose to enter manually - just close the search modal
        SelectedAttorneyVendor = null;
    }

    private void ClearSelectedAttorney()
    {
        SelectedAttorneyVendor = null;
        Passenger.AttorneyInfo = new AttorneyInfo { Address = new Address() };
        AttorneyPhoneDisplay = "";
    }

    private bool IsFormValid()
    {
        // ONLY the Passenger Name is required to set up a claim
        // All other fields (email, phone, FEIN, attorney, etc.) are OPTIONAL
        if (string.IsNullOrWhiteSpace(Passenger.Name))
            return false;

        // If injured, must have injury type and description
        if (Passenger.WasInjured)
        {
            if (Passenger.InjuryInfo == null ||
                string.IsNullOrEmpty(Passenger.InjuryInfo.InjuryType) ||
                string.IsNullOrEmpty(Passenger.InjuryInfo.InjuryDescription))
                return false;
        }

        // Attorney information is OPTIONAL even if HasAttorney is true
        // User can indicate they have an attorney but fill in details later

        return true;
    }

    private async Task OnAdd()
    {
        if (IsFormValid())
        {
            await OnPassengerAdded.InvokeAsync(Passenger);
            await JS.InvokeVoidAsync("HideModal", "passengerModal");
        }
    }

    private async Task OnCancel()
    {
        await OnCancelled.InvokeAsync();
        await JS.InvokeVoidAsync("HideModal", "passengerModal");
    }

    private void OnPassengerPhoneChanged(ChangeEventArgs e)
    {
        var rawValue = e.Value?.ToString() ?? "";
        Passenger.PhoneNumber = new string(rawValue.Where(char.IsDigit).ToArray());
        PassengerPhoneDisplay = FormatPhoneNumber(Passenger.PhoneNumber);
    }

    private void OnAttorneyPhoneChanged(ChangeEventArgs e)
    {
        if (Passenger.AttorneyInfo == null) return;
        var rawValue = e.Value?.ToString() ?? "";
        Passenger.AttorneyInfo.PhoneNumber = new string(rawValue.Where(char.IsDigit).ToArray());
        AttorneyPhoneDisplay = FormatPhoneNumber(Passenger.AttorneyInfo.PhoneNumber);
    }

    private string FormatPhoneNumber(string? phone)
    {
        if (string.IsNullOrEmpty(phone))
            return "";
        
        var digits = new string(phone.Where(char.IsDigit).ToArray());
        
        if (digits.Length == 10)
            return string.Format("({0}) {1}-{2}", digits.Substring(0, 3), digits.Substring(3, 3), digits.Substring(6));
        else if (digits.Length == 11 && digits[0] == '1')
            return string.Format("+1 ({0}) {1}-{2}", digits.Substring(1, 3), digits.Substring(4, 3), digits.Substring(7));
        
        return phone;
    }
}
