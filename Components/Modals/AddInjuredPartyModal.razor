@using ClaimsPortal.Models
@using ClaimsPortal.Components.Modals

<div class="modal fade" id="addInjuredPartyModal" tabindex="-1" role="dialog" aria-labelledby="addInjuredPartyModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addInjuredPartyModalLabel">Add Injured Party</h5>
                <button type="button" class="btn-close" @onclick="OnCancel" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Simplified modal to avoid Razor parse issues during diagnostics -->
                <div class="mb-2">Name: <input class="form-control" value="@(NewParty?.Name ?? string.Empty)" @oninput="e => { NewParty ??= new ThirdParty(); NewParty.Name = ((ChangeEventArgs)e).Value?.ToString() ?? string.Empty; }" /></div>
                <div class="mb-2">Phone: <input class="form-control" value="@(NewParty?.PhoneNumber ?? string.Empty)" @oninput="e => { NewParty ??= new ThirdParty(); NewParty.PhoneNumber = ((ChangeEventArgs)e).Value?.ToString() ?? string.Empty; }" /></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" @onclick="OnCancel">Cancel</button>
                <button type="button" class="btn btn-primary" @onclick="SaveAndCreateFeature">Save & Create Feature</button>
            </div>
        </div>
    </div>
</div>

<AttorneySearchModal @ref="attorneySearchModal" ModalId="addInjuredPartyAttorneySearchModal" OnAttorneySelected="OnAttorneySelected" OnManualEntry="OnAttorneyManualEntry" OnCancelled="() => {}" />
<HospitalSearchModal @ref="hospitalSearchModal" ModalId="addInjuredPartyHospitalSearchModal" OnHospitalSelected="OnHospitalSelected" OnManualEntry="OnHospitalManualEntry" OnCancelled="() => {}" />

@code {
    [Inject]
    private IJSRuntime JS { get; set; } = null!;

    private ThirdParty NewParty { get; set; } = new ThirdParty
    {
        Address = new Address(),
        InjuryInfo = new Injury(),
        AttorneyInfo = new AttorneyInfo { Address = new Address() }
    };

    [Parameter]
    public EventCallback<ThirdParty> OnInjuredPartyAdded { get; set; }

    private AttorneySearchModal? attorneySearchModal;
    private HospitalSearchModal? hospitalSearchModal;

    protected override void OnInitialized()
    {
        NewParty ??= new ThirdParty();
        NewParty.Address ??= new Address();
        NewParty.InjuryInfo ??= new Injury();
        NewParty.AttorneyInfo ??= new AttorneyInfo { Address = new Address() };
    }

    public async Task ShowAsync(ThirdParty vehicle)
    {
        NewParty = new ThirdParty { Type = "Passenger", Address = new Address(), InjuryInfo = new Injury(), AttorneyInfo = new AttorneyInfo { Address = new Address() } };
        await InvokeAsync(StateHasChanged);
        await JS.InvokeVoidAsync("ShowModal", "addInjuredPartyModal");
    }

    public async Task HideAsync() => await JS.InvokeVoidAsync("HideModal", "addInjuredPartyModal");

    private async Task SaveAndCreateFeature()
    {
        if (OnInjuredPartyAdded.HasDelegate)
            await OnInjuredPartyAdded.InvokeAsync(NewParty);
        await InvokeAsync(StateHasChanged);
    }

    private async Task OnCancel() => await JS.InvokeVoidAsync("HideModal", "addInjuredPartyModal");

    private async Task OnAttorneySelected(AttorneyInfo info)
    {
        NewParty.HasAttorney = true;
        NewParty.AttorneyInfo = info ?? new AttorneyInfo { Address = new Address() };
        await InvokeAsync(StateHasChanged);
    }

    private void OnAttorneyManualEntry() { }

    private async Task OnHospitalSelected(HospitalInfo info)
    {
        NewParty.InjuryInfo ??= new Injury();
        NewParty.InjuryInfo.HospitalName = info?.Name;
        await InvokeAsync(StateHasChanged);
    }

    private void OnHospitalManualEntry() { }
}
