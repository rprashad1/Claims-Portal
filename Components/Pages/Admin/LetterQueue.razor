@page "/admin/letterqueue"
@using System.Net.Http.Json
@using ClaimsPortal.Data
@rendermode InteractiveServer

<SectionCard Title="Letter Generation Queue" SubTitle="View and manage pending letter generation jobs">
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead class="table-light">
                        <tr>
                            <th>QueueId</th>
                            <th>Claim</th>
                            <th>Selected Rules</th>
                            <th>Status</th>
                            <th>Tries</th>
                            <th>Created</th>
                            <th>LastAttempt</th>
                            <th>LastError</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Jobs == null)
                        {
                            <tr><td colspan="9">Loading...</td></tr>
                        }
                        else if (!Jobs.Any())
                        {
                            <tr><td colspan="9">No jobs found.</td></tr>
                        }
                        else
                        {
                            foreach (var j in Jobs)
                            {
                                <tr>
                                    <td>@j.QueueId</td>
                                    <td>@j.ClaimNumber</td>
                                    <td>@j.SelectedRuleIds</td>
                                    <td>@j.Status</td>
                                    <td>@j.Tries</td>
                                    <td>@(j.CreatedAt?.ToString("u"))</td>
                                    <td>@(j.LastAttemptAt?.ToString("u"))</td>
                                    <td style="max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">@j.LastError</td>
                                    <td class="text-end">
                                        @if (j.Status == "Pending")
                                        {
                                            <button class="btn btn-sm btn-secondary" @onclick="() => Requeue(j.QueueId)">Requeue</button>
                                        }
                                        else
                                        {
                                            <button class="btn btn-sm btn-primary" @onclick="() => Requeue(j.QueueId)">Requeue</button>
                                        }
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</SectionCard>

@code {
    [Inject]
    private HttpClient Http { get; set; } = null!;

    private List<LetterQueueItem>? Jobs;

    protected override async Task OnInitializedAsync()
    {
        await LoadJobs();
    }

    private async Task LoadJobs()
    {
        Jobs = await Http.GetFromJsonAsync<List<LetterQueueItem>>("/api/letterqueue");
        StateHasChanged();
    }

    private async Task Requeue(long id)
    {
        var res = await Http.PostAsync($"/api/letterqueue/{id}/requeue", null);
        if (res.IsSuccessStatusCode)
        {
            await LoadJobs();
        }
        else
        {
            var txt = await res.Content.ReadAsStringAsync();
            Console.WriteLine($"Requeue failed: {txt}");
        }
    }

    private class LetterQueueItem
    {
        public long QueueId { get; set; }
        public string ClaimNumber { get; set; } = string.Empty;
        public string? SelectedRuleIds { get; set; }
        public string Status { get; set; } = string.Empty;
        public int Tries { get; set; }
        public DateTimeOffset? CreatedAt { get; set; }
        public DateTimeOffset? LastAttemptAt { get; set; }
        public string? LastError { get; set; }
    }
}
