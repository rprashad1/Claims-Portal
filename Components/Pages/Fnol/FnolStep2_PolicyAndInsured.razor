@using ClaimsPortal.Models
@using ClaimsPortal.Services
@using ClaimsPortal.Components.Modals
@using ClaimsPortal.Components.Shared
@rendermode InteractiveServer

<SectionCard Title="Insured Vehicle & Information" 
             SubTitle="Select the insured vehicle and confirm insured details"
             StepNumber="2"
             OnNext="OnNext"
             OnPrevious="OnPrevious"
             IsNextDisabled="@IsNextDisabled">

    @if (PolicyInfo != null)
    {
        <div class="alert alert-success mb-4">
            <h6 class="mb-2">
                <i class="bi bi-check-circle-fill me-2"></i> Policy Verified
            </h6>
            <div class="row g-3 mb-3">
                <div class="col-md-3">
                    <small class="text-muted d-block">Policy Number</small>
                    <strong>@PolicyInfo.PolicyNumber</strong>
                </div>
                <div class="col-md-3">
                    <small class="text-muted d-block">Renewal Number</small>
                    <strong>@PolicyInfo.RenewalNumber</strong>
                </div>
                <div class="col-md-3">
                    <small class="text-muted d-block">Effective Date</small>
                    <strong>@PolicyInfo.EffectiveDate.ToString("MM/dd/yyyy")</strong>
                </div>
                <div class="col-md-3">
                    <small class="text-muted d-block">Status</small>
                    <span class="badge @GetStatusBadgeClass(PolicyInfo.Status)">@PolicyInfo.Status</span>
                </div>
            </div>
            <div class="row g-3">
                <div class="col-md-3">
                    <small class="text-muted d-block">Expiration Date</small>
                    <strong>@PolicyInfo.ExpiryDate.ToString("MM/dd/yyyy")</strong>
                </div>
                <div class="col-md-3">
                    <small class="text-muted d-block">Cancel Date</small>
                    <strong>@(PolicyInfo.CancelDate?.ToString("MM/dd/yyyy") ?? "N/A")</strong>
                </div>
                <div class="col-md-3">
                    <small class="text-muted d-block">Insured Name</small>
                    <strong>@PolicyInfo.InsuredName</strong>
                </div>
                <div class="col-md-3">
                    <small class="text-muted d-block">Phone</small>
                    <strong>@FormatPhoneNumber(PolicyInfo.PhoneNumber)</strong>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header bg-light">
                <h6 class="mb-0">Vehicle Information</h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Select Vehicle From Policy *</label>
                    <select class="form-select" value="@SelectedVehicleVin" @onchange="OnVehicleSelected">
                        <option value="">-- Select Vehicle by VIN --</option>
                        @foreach (var vehicle in AvailableVehicles)
                        {
                            <option value="@vehicle.Vin">@vehicle.Vin - @vehicle.Year @vehicle.Make @vehicle.Model</option>
                        }
                        <option value="unlisted">-- Vehicle Not Listed on Policy --</option>
                    </select>
                </div>

                @if (!string.IsNullOrEmpty(SelectedVehicleVin) && SelectedVehicleVin != "unlisted")
                {
                    <div class="alert alert-info mb-3">
                        <i class="bi bi-info-circle"></i> Vehicle information auto-filled from policy
                    </div>
                    
                    <!-- Vehicle Details Display Section -->
                    <div class="border rounded p-3 mb-3 bg-light">
                        <h6 class="mb-3"><i class="bi bi-car-front me-2"></i>Vehicle Details</h6>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <small class="text-muted d-block">VIN</small>
                                <strong>@InsuredVehicle.Vin</strong>
                            </div>
                            <div class="col-md-2">
                                <small class="text-muted d-block">Year</small>
                                <strong>@InsuredVehicle.Year</strong>
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted d-block">Make</small>
                                <strong>@InsuredVehicle.Make</strong>
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted d-block">Model</small>
                                <strong>@InsuredVehicle.Model</strong>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="form-label">License Plate #</label>
                            <input type="text" class="form-control" @bind="InsuredVehicle.PlateNumber" placeholder="Enter license plate number" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">License Plate State</label>
                            <input type="text" class="form-control" @bind="InsuredVehicle.PlateState" maxlength="2" placeholder="e.g., TX" />
                        </div>
                    </div>
                }

                @if (SelectedVehicleVin == "unlisted")
                {
                    <div class="row g-3 mb-3">
                        <div class="col-md-4">
                            <label class="form-label">VIN *</label>
                            <input type="text" class="form-control" @bind="InsuredVehicle.Vin" placeholder="Vehicle Identification Number" />
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Year *</label>
                            <input type="number" class="form-control" @bind="InsuredVehicle.Year" placeholder="Year" />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Make *</label>
                            <input type="text" class="form-control" @bind="InsuredVehicle.Make" placeholder="e.g., Toyota" />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Model *</label>
                            <input type="text" class="form-control" @bind="InsuredVehicle.Model" placeholder="e.g., Camry" />
                        </div>
                    </div>
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="form-label">License Plate #</label>
                            <input type="text" class="form-control" @bind="InsuredVehicle.PlateNumber" placeholder="Enter license plate number" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">License Plate State</label>
                            <input type="text" class="form-control" @bind="InsuredVehicle.PlateState" maxlength="2" placeholder="e.g., TX" />
                        </div>
                    </div>
                }
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header bg-light">
                <h6 class="mb-0">Vehicle Conditions</h6>
            </div>
            <div class="card-body">
                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="isDamaged" @bind="InsuredVehicle.IsDamaged" />
                            <label class="form-check-label" for="isDamaged">Vehicle is Damaged</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="isDrivable" @bind="InsuredVehicle.IsDrivable" />
                            <label class="form-check-label" for="isDrivable">Vehicle is Drivable</label>
                        </div>
                    </div>
                </div>
                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="wasTowed" @bind="InsuredVehicle.WasTowed" />
                            <label class="form-check-label" for="wasTowed">Vehicle Was Towed</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="hasDashCam" @bind="InsuredVehicle.HasDashCam" />
                            <label class="form-check-label" for="hasDashCam">Dash Cam Installed</label>
                        </div>
                    </div>
                </div>
                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="inStorage" @bind="InsuredVehicle.InStorage" />
                            <label class="form-check-label" for="inStorage">Vehicle in Storage</label>
                        </div>
                    </div>
                    @if (InsuredVehicle.InStorage)
                    {
                        <div class="col-md-6">
                            <label class="form-label">Storage Location</label>
                            <input type="text" class="form-control" @bind="InsuredVehicle.StorageLocation" />
                        </div>
                    }
                </div>
                @if (InsuredVehicle.IsDamaged)
                {
                    <div class="border-top pt-3 mt-4">
                        <h6 class="mb-3">Vehicle Damage Information</h6>
                        <div class="mb-3">
                            <label class="form-label">Damage Details</label>
                            <textarea class="form-control" rows="4" @bind="InsuredVehicle.DamageDetails"></textarea>
                        </div>
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="didRollOver" @bind="InsuredVehicle.DidVehicleRollOver" />
                                    <label class="form-check-label" for="didRollOver">Vehicle Did Roll Over</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="hadWaterDamage" @bind="InsuredVehicle.HadWaterDamage" />
                                    <label class="form-check-label" for="hadWaterDamage">Had Water Damage</label>
                                </div>
                            </div>
                        </div>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="headlightsOn" @bind="InsuredVehicle.AreHeadlightsOn" />
                                    <label class="form-check-label" for="headlightsOn">Headlights Were On</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="airbagDeploy" @bind="InsuredVehicle.DidAirbagDeploy" />
                                    <label class="form-check-label" for="airbagDeploy">Air Bag Deployed</label>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header bg-light">
                <h6 class="mb-0">Insured Information (Read Only)</h6>
            </div>
            <div class="card-body">
                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Insured Name</label>
                        <input type="text" class="form-control" value="@PolicyInfo.InsuredName" disabled />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Doing Business As</label>
                        <input type="text" class="form-control" value="@PolicyInfo.DoingBusinessAs" disabled />
                    </div>
                </div>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Phone</label>
                        <input type="text" class="form-control" value="@FormatPhoneNumber(PolicyInfo.PhoneNumber)" disabled />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Email</label>
                        <input type="text" class="form-control" value="@PolicyInfo.Email" disabled />
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header bg-light">
                <h6 class="mb-0">Insured Address (Read Only)</h6>
            </div>
            <div class="card-body">
                <div class="row g-3 mb-3">
                    <div class="col-md-12">
                        <label class="form-label">Street Address</label>
                        <input type="text" class="form-control" value="@PolicyInfo.Address" disabled />
                    </div>
                </div>
                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Address Line 2</label>
                        <input type="text" class="form-control" value="@PolicyInfo.Address2" disabled />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">City</label>
                        <input type="text" class="form-control" value="@PolicyInfo.City" disabled />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">State</label>
                        <input type="text" class="form-control" value="@PolicyInfo.State" disabled />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Zip Code</label>
                        <input type="text" class="form-control" value="@PolicyInfo.ZipCode" disabled />
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header bg-light">
                <h6 class="mb-0">Contact Person (Editable)</h6>
            </div>
            <div class="card-body">
                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Contact Name</label>
                        <input type="text" class="form-control" @bind="ContactPerson" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Phone</label>
                        <input type="tel" class="form-control" value="@ContactPhoneDisplay" @onchange="OnContactPhoneChanged" />
                    </div>
                </div>
                <div class="mb-0">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-control" @bind="ContactEmail" />
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-warning mb-4">
            <h6 class="mb-2">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>Unverified / CIQ Claim
            </h6>
            <p class="mb-0">This claim is being setup without policy verification. Please enter vehicle information manually.</p>
        </div>

        <div class="card mb-4">
            <div class="card-header bg-light">
                <h6 class="mb-0">Vehicle Information (Manual Entry)</h6>
            </div>
            <div class="card-body">
                <div class="row g-3 mb-3">
                    <div class="col-md-4">
                        <label class="form-label">VIN</label>
                        <input type="text" class="form-control" @bind="InsuredVehicle.Vin" placeholder="Vehicle Identification Number" />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Year</label>
                        <input type="number" class="form-control" @bind="InsuredVehicle.Year" placeholder="Year" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Make</label>
                        <input type="text" class="form-control" @bind="InsuredVehicle.Make" placeholder="e.g., Toyota" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Model</label>
                        <input type="text" class="form-control" @bind="InsuredVehicle.Model" placeholder="e.g., Camry" />
                    </div>
                </div>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">License Plate #</label>
                        <input type="text" class="form-control" @bind="InsuredVehicle.PlateNumber" placeholder="Enter license plate number" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">License Plate State</label>
                        <input type="text" class="form-control" @bind="InsuredVehicle.PlateState" maxlength="2" placeholder="e.g., TX" />
                    </div>
                </div>
            </div>
        </div>
    }
</SectionCard>

@code {
    [Inject]
    private IPolicyService PolicyService { get; set; } = null!;

    [Parameter]
    public EventCallback OnNext { get; set; }

    [Parameter]
    public EventCallback OnPrevious { get; set; }

    [Parameter]
    public Policy? InitialPolicyInfo { get; set; }

    [Parameter]
    public VehicleInfo? InitialVehicle { get; set; }

    [Parameter]
    public string? InitialStatus { get; set; }

    private Policy? PolicyInfo;
    private List<PolicyVehicle> AvailableVehicles = new();
    private string SelectedVehicleVin = string.Empty;

    private string ContactPerson = string.Empty;
    private string ContactPhone = string.Empty;
    private string ContactPhoneDisplay = string.Empty;
    private string ContactEmail = string.Empty;

    private VehicleInfo InsuredVehicle = new();

    protected override void OnInitialized()
    {
        LoadPolicyAndVehicleData();
    }

    protected override void OnParametersSet()
    {
        base.OnParametersSet();
        LoadPolicyAndVehicleData();
    }

    private void LoadPolicyAndVehicleData()
    {
        // Load policy info from initial parameters
        if (InitialPolicyInfo != null && !string.IsNullOrEmpty(InitialPolicyInfo.PolicyNumber))
        {
            // Only update if we have actual policy data (not just a policy number)
            if (PolicyInfo == null || 
                PolicyInfo.PolicyNumber != InitialPolicyInfo.PolicyNumber ||
                string.IsNullOrEmpty(PolicyInfo.InsuredName) && !string.IsNullOrEmpty(InitialPolicyInfo.InsuredName))
            {
                PolicyInfo = InitialPolicyInfo;
                AvailableVehicles = InitialPolicyInfo.Vehicles ?? new();
                ContactPerson = InitialPolicyInfo.ContactPerson ?? "";
                ContactPhone = InitialPolicyInfo.ContactPhone ?? "";
                ContactPhoneDisplay = FormatPhoneNumber(ContactPhone);
                ContactEmail = InitialPolicyInfo.ContactEmail ?? "";
            }
        }
        
        // Load vehicle info from initial parameters
        if (InitialVehicle != null && !string.IsNullOrEmpty(InitialVehicle.Vin))
        {
            if (InsuredVehicle == null || string.IsNullOrEmpty(InsuredVehicle.Vin) || InsuredVehicle.Vin != InitialVehicle.Vin)
            {
                InsuredVehicle = InitialVehicle;
                SelectedVehicleVin = InitialVehicle.Vin;
            }
        }
    }

    private void OnVehicleSelected(ChangeEventArgs e)
    {
        var selectedVin = e.Value?.ToString() ?? "";
        SelectedVehicleVin = selectedVin;
        
        if (string.IsNullOrEmpty(selectedVin))
        {
            // Reset vehicle info
            InsuredVehicle = new VehicleInfo();
        }
        else if (selectedVin == "unlisted")
        {
            // Clear for manual entry but mark as unlisted
            InsuredVehicle = new VehicleInfo { IsListed = false };
        }
        else
        {
            // Find the selected vehicle from policy and populate InsuredVehicle
            var policyVehicle = AvailableVehicles.FirstOrDefault(v => v.Vin == selectedVin);
            if (policyVehicle != null)
            {
                InsuredVehicle = new VehicleInfo
                {
                    Vin = policyVehicle.Vin,
                    Make = policyVehicle.Make,
                    Model = policyVehicle.Model,
                    Year = policyVehicle.Year,
                    PlateNumber = policyVehicle.PlateNumber ?? "",
                    PlateState = policyVehicle.PlateState ?? "",
                    IsListed = true
                };
            }
        }
        
        StateHasChanged();
    }

    private bool IsNextDisabled => string.IsNullOrEmpty(InsuredVehicle.Vin) && string.IsNullOrEmpty(SelectedVehicleVin);

    public async Task<bool> ValidateAsync()
    {
        return !IsNextDisabled;
    }

    public Policy GetPolicyInfo()
    {
        if (PolicyInfo == null)
        {
            return new Policy 
            { 
                PolicyNumber = "",
                Status = "Unverified",
                ContactPerson = ContactPerson,
                ContactPhone = ContactPhone,
                ContactEmail = ContactEmail
            };
        }
        
        PolicyInfo.ContactPerson = ContactPerson;
        PolicyInfo.ContactPhone = ContactPhone;
        PolicyInfo.ContactEmail = ContactEmail;
        return PolicyInfo;
    }

    public VehicleInfo GetInsuredVehicle() => InsuredVehicle;

    public string GetClaimStatus()
    {
        if (PolicyInfo == null)
            return "CIQ";
        return PolicyInfo.Status == "Active" ? "Open" : "CIQ";
    }

    private void OnContactPhoneChanged(ChangeEventArgs e)
    {
        var rawValue = e.Value?.ToString() ?? "";
        ContactPhone = new string(rawValue.Where(char.IsDigit).ToArray());
        ContactPhoneDisplay = FormatPhoneNumber(ContactPhone);
    }

    private string FormatPhoneNumber(string? phone)
    {
        if (string.IsNullOrEmpty(phone))
            return "";
        
        var digits = new string(phone.Where(char.IsDigit).ToArray());
        
        if (digits.Length == 10)
            return string.Format("({0}) {1}-{2}", digits.Substring(0, 3), digits.Substring(3, 3), digits.Substring(6));
        else if (digits.Length == 11 && digits[0] == '1')
            return string.Format("+1 ({0}) {1}-{2}", digits.Substring(1, 3), digits.Substring(4, 3), digits.Substring(7));
        
        return phone;
    }

    private string GetStatusBadgeClass(string status)
    {
        return status switch
        {
            "Active" => "bg-success",
            "Expired" => "bg-warning",
            "Cancelled" => "bg-danger",
            _ => "bg-secondary"
        };
    }
}
