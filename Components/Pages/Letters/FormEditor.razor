@using System.Net.Http.Json
@inject IHttpClientFactory HttpClientFactory
@inject IJSRuntime JS
@inject NavigationManager NavigationManager

@code {
    [Parameter] public string TemplateName { get; set; } = string.Empty;
    [Parameter] public string ClaimNumber { get; set; } = string.Empty;
    [Parameter] public string DocumentNumber { get; set; } = string.Empty;

    private Dictionary<string, string> Fields = new();
    private string StatusMessage = string.Empty;
    private bool Loading = true;
    private string? PreviewUrl;
    private long MaxUploadBytes = 50 * 1024 * 1024; // 50 MB
    private bool ShowEditor = false;
    private string EditedHtml = string.Empty;
    private ElementReference editDivRef;

    protected override async Task OnInitializedAsync()
    {
        Loading = true;
        try
        {
            var client = HttpClientFactory.CreateClient();
            client.BaseAddress = new Uri(NavigationManager.BaseUri);
            var resp = await client.PostAsJsonAsync("/api/letters/fields", new { templateName = TemplateName });
            resp.EnsureSuccessStatusCode();
            var obj = await resp.Content.ReadFromJsonAsync<Dictionary<string, string[]>>();
            var fields = obj != null && obj.TryGetValue("fields", out var arr) ? arr : Array.Empty<string>();

            // initialize dictionary
            foreach (var f in fields)
            {
                if (!Fields.ContainsKey(f)) Fields[f] = string.Empty;
            }

            // load saved values
            var loadResp = await client.GetAsync($"/api/letters/form/load/{ClaimNumber}/{DocumentNumber}");
            if (loadResp.IsSuccessStatusCode)
            {
                var loaded = await loadResp.Content.ReadFromJsonAsync<Dictionary<string, Dictionary<string, string>>>();
                if (loaded != null && loaded.TryGetValue("fields", out var map))
                {
                    foreach (var kv in map) Fields[kv.Key] = kv.Value;
                }
            }
        }
        catch (Exception ex)
        {
            StatusMessage = "Error loading form: " + ex.Message;
        }
        finally
        {
            Loading = false;
        }
    }

    private async Task SaveAsync()
    {
        var client = HttpClientFactory.CreateClient();
        client.BaseAddress = new Uri(NavigationManager.BaseUri);
        var payload = new
        {
            claimNumber = ClaimNumber,
            documentNumber = DocumentNumber,
            fields = Fields
        };
        var resp = await client.PostAsJsonAsync("/api/letters/form/save", payload);
        if (resp.IsSuccessStatusCode) StatusMessage = "Saved"; else StatusMessage = "Save failed";
    }

    private async Task FlattenAsync()
    {
        var client = HttpClientFactory.CreateClient();
        client.BaseAddress = new Uri(NavigationManager.BaseUri);
        var payload = new
        {
            claimNumber = ClaimNumber,
            documentNumber = DocumentNumber,
            templateName = TemplateName
        };
        var resp = await client.PostAsJsonAsync("/api/letters/form/flatten", payload);
        if (resp.IsSuccessStatusCode)
        {
            var json = await resp.Content.ReadFromJsonAsync<Dictionary<string, string>>();
            if (json != null && json.TryGetValue("file", out var file))
            {
                StatusMessage = "Flattened: " + file;
            }
            else StatusMessage = "Flatten succeeded";
        }
        else
        {
            StatusMessage = "Flatten failed";
        }
    }

    private async Task PreviewAsync()
    {
        var client = HttpClientFactory.CreateClient();
        var payload = new
        {
            templateName = TemplateName,
            fields = Fields
        };
        var resp = await client.PostAsJsonAsync("/api/letters/form/preview", payload);
        if (resp.IsSuccessStatusCode)
        {
            var json = await resp.Content.ReadFromJsonAsync<Dictionary<string, string>>();
            if (json != null && json.TryGetValue("file", out var file))
            {
                PreviewUrl = file;
                StatusMessage = "Preview generated";
            }
        }
        else
        {
            StatusMessage = "Preview failed";
        }
    }

    private async Task UploadAsync(Microsoft.AspNetCore.Components.Forms.InputFileChangeEventArgs e)
    {
        try
        {
            var file = e.File;
            var client = HttpClientFactory.CreateClient();
            client.BaseAddress = new Uri(NavigationManager.BaseUri);
            using var ms = new MemoryStream();
            await file.OpenReadStream(MaxUploadBytes).CopyToAsync(ms);
            ms.Position = 0;

            using var content = new MultipartFormDataContent();
            var fileContent = new ByteArrayContent(ms.ToArray());
            fileContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue(file.ContentType ?? "application/pdf");
            content.Add(fileContent, "file", file.Name);
            content.Add(new StringContent(ClaimNumber ?? string.Empty), "claimNumber");
            content.Add(new StringContent(DocumentNumber ?? string.Empty), "documentNumber");

            var resp = await client.PostAsync("/api/letters/form/upload", content);
            if (resp.IsSuccessStatusCode)
            {
                var obj = await resp.Content.ReadFromJsonAsync<Dictionary<string, object>>();
                if (obj != null && obj.TryGetValue("fields", out var fobj) && fobj is System.Text.Json.JsonElement je && je.ValueKind == System.Text.Json.JsonValueKind.Object)
                {
                    foreach (var prop in je.EnumerateObject())
                    {
                        var name = prop.Name;
                        var val = prop.Value.GetString() ?? string.Empty;
                        if (!Fields.ContainsKey(name)) Fields[name] = val; else Fields[name] = val;
                    }
                }
                StatusMessage = "Upload processed and fields extracted";
            }
            else
            {
                StatusMessage = "Upload failed";
            }
        }
        catch (Exception ex)
        {
            StatusMessage = "Upload error: " + ex.Message;
        }
    }

    private async Task RenderForEditAsync()
    {
        try
        {
            var client = HttpClientFactory.CreateClient();
            client.BaseAddress = new Uri(NavigationManager.BaseUri);
            var payload = new { templateName = TemplateName, fields = Fields };
            var resp = await client.PostAsJsonAsync("/api/letters/form/render", payload);
            if (resp.IsSuccessStatusCode)
            {
                EditedHtml = await resp.Content.ReadAsStringAsync();
                ShowEditor = true;
                // allow UI to render then set innerHTML via JS
                await Task.Delay(50);
                await JS.InvokeVoidAsync("letterEditor.setHtml", editDivRef, EditedHtml);
            }
            else
            {
                StatusMessage = "Render for edit failed";
            }
        }
        catch (Exception ex)
        {
            StatusMessage = "Render error: " + ex.Message;
        }
    }

    private async Task SaveHtmlAsync()
    {
        try
        {
            var client = HttpClientFactory.CreateClient();
            client.BaseAddress = new Uri(NavigationManager.BaseUri);
            // read current innerHTML from editable div
            var currentHtml = await JS.InvokeAsync<string>("letterEditor.getHtml", editDivRef);
            var payload = new { claimNumber = ClaimNumber, documentNumber = DocumentNumber, html = currentHtml };
            var resp = await client.PostAsJsonAsync("/api/letters/form/saveHtml", payload);
            if (resp.IsSuccessStatusCode)
            {
                StatusMessage = "Saved edited HTML";
                ShowEditor = false;
            }
            else
            {
                StatusMessage = "Save edited HTML failed";
            }
        }
        catch (Exception ex)
        {
            StatusMessage = "Save error: " + ex.Message;
        }
    }
}

<div class="form-editor">
    @if (Loading)
    {
        <p>Loading...</p>
    }
    else
    {
        <div>
            <h3>Form: @TemplateName</h3>
            <p>Claim: @ClaimNumber â€¢ Document: @DocumentNumber</p>
            <div>
                @foreach (var kv in Fields.ToList())
                {
                    <div class="form-group">
                        <label>@kv.Key</label>
                        <input class="form-control" @bind="Fields[kv.Key]" />
                    </div>
                }
            </div>
            <div class="mt-2">
                <button class="btn btn-primary" @onclick="SaveAsync">Save</button>
                <button class="btn btn-secondary" @onclick="PreviewAsync">Preview</button>
                <button class="btn btn-secondary" @onclick="FlattenAsync">Flatten</button>
                <button class="btn btn-outline-primary ms-2" @onclick="RenderForEditAsync">Edit Letter</button>
                <label class="btn btn-outline-secondary ms-2">
                    Upload filled PDF <InputFile OnChange="UploadAsync" />
                </label>
            </div>
            <div class="mt-2">@StatusMessage</div>
            @if (!string.IsNullOrEmpty(PreviewUrl))
            {
                <div class="mt-3">
                    <h5>Preview</h5>
                    <iframe src="@PreviewUrl" style="width:100%;height:800px;border:1px solid #ccc"></iframe>
                </div>
            }
            @if (ShowEditor)
            {
                <div class="modal" style="display:block;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;">
                    <div class="modal-dialog" style="max-width:90%;margin:40px auto;background:#fff;padding:16px;border-radius:6px;">
                        <h5>Edit Letter HTML</h5>
                        <p>Edit the rendered HTML directly. Save will use this HTML for final generation.</p>
                        <div contenteditable="true" @ref="editDivRef" style="width:100%;height:60vh;border:1px solid #ddd;padding:8px;overflow:auto;background:#fff"></div>
                        <div class="mt-2">
                            <button class="btn btn-primary" @onclick="SaveHtmlAsync">Save Edited HTML</button>
                            <button class="btn btn-secondary ms-2" @onclick="(()=> ShowEditor = false)">Close</button>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>
